<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V2G聚合平台模拟器</title>
    <style>
        /* CSS变量定义 */
        :root {
            --white: #ffffff;
    --primary-color: #00a854;
    --secondary-color: #1890ff;
    --error-color: #F5222D;
    --text-primary: #333333;
    --text-secondary: #666666;
    --text-light: #999999;
            --background-color: #f5f5f5;
            --border-color: #e0e0e0;
        }

        /* 基础样式 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color-primary);
            min-height: 100vh;
            padding: 20rpx;
        }
        .container {
            padding: 20rpx;
            background-color: var(--background-color);
        }
        /* 顶部导航栏 */
        .navbar {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        .navbar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s ease;
        }
        .navbar:hover::before {
            left: 100%;
        }
        .navbar-title {
            font-size: 20px;
            font-weight: bold;
        }
        .navbar-icon {
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        .navbar-icon:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        /* 导航菜单 */
        .navbar-menu {
            display: flex;
            gap: 20px;
        }
        
        .navbar-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .navbar-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .navbar-link.active {
            background-color: rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }
        /* 内容区域 */
        .container > div:not(.navbar) {
            padding: 24px;
        }
        
        /* 响应式设计 */
        /* 超小屏幕（手机，小于320px） */
        @media (max-width: 320px) {
            body {
                padding: 0;
            }
            .container {
                padding: 0;
            }
            .navbar {
                padding: 16px 20px;
            }
            .navbar-title {
                font-size: 18px;
            }
            .status-card,
            .data-card,
            .control-section,
            .bind-section,
            .car-list-section {
                margin-bottom: 0;
                border-radius: 0;
                box-shadow: none;
                border-bottom: 1px solid var(--border-color);
                padding: 20px;
            }
            .data-cards {
                flex-direction: column;
                margin-bottom: 0;
            }
            .data-card {
                margin-right: 0;
                margin-bottom: 10px;
                padding: 20px;
            }
            .data-card:last-child {
                margin-bottom: 0;
            }
            .control-section {
                flex-direction: column;
            }
            .control-btn {
                margin-right: 0;
                margin-bottom: 10px;
            }
            .control-btn:last-child {
                margin-bottom: 0;
            }
            .status-value {
                font-size: 56rpx;
            }
            .status-label {
                font-size: 24rpx;
            }
            .data-value {
                font-size: 36rpx;
            }
            .data-label {
                font-size: 22rpx;
            }
            .btn {
                padding: 20px;
                font-size: 26rpx;
            }
            /* 智能充放电模态框 */
            .modal-content {
                width: 95%;
                margin: 20px auto;
                padding: 20px;
            }
            .tab-btn {
                font-size: 24rpx;
                padding: 14rpx 0;
            }
            /* 车辆列表 */
            .car-item {
                padding: 16px;
                font-size: 24rpx;
            }
        }
        
        /* 小屏幕（手机，320px-414px） */
        @media (min-width: 321px) and (max-width: 414px) {
            body {
                padding: 0;
            }
            .container {
                padding: 0;
            }
            .navbar {
                padding: 18px 22px;
            }
            .navbar-title {
                font-size: 19px;
            }
            .status-card,
            .data-card,
            .control-section,
            .bind-section,
            .car-list-section {
                margin-bottom: 0;
                border-radius: 0;
                box-shadow: none;
                border-bottom: 1px solid var(--border-color);
                padding: 22px;
            }
            .data-cards {
                flex-direction: column;
                margin-bottom: 0;
            }
            .data-card {
                margin-right: 0;
                margin-bottom: 12px;
                padding: 22px;
            }
            .data-card:last-child {
                margin-bottom: 0;
            }
            .control-section {
                flex-direction: column;
            }
            .control-btn {
                margin-right: 0;
                margin-bottom: 12px;
            }
            .control-btn:last-child {
                margin-bottom: 0;
            }
            /* 智能充放电模态框 */
            .modal-content {
                width: 90%;
                margin: 25px auto;
                padding: 24px;
            }
            /* 车辆列表 */
            .car-item {
                padding: 18px;
            }
        }
        
        /* 预约页面样式 */
        .form-item {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background-color: #fafafa;
        }
        
        .slider-container {
            margin: 16px 0;
        }
        
        .slider-value {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }
        
        .safety-tip {
            font-size: 12px;
            color: #ff7875;
            margin-top: 12px;
            padding: 8px 12px;
            background-color: #fff5f5;
            border-radius: 6px;
            border-left: 3px solid #ff7875;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .radio-item input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.1);
        }
        
        /* 中等屏幕（平板，415px-768px） */
        @media (min-width: 415px) and (max-width: 768px) {
            .status-card,
            .data-card,
            .control-section,
            .bind-section,
            .car-list-section {
                margin-bottom: 15px;
                padding: 24px;
            }
            .data-cards {
                flex-wrap: wrap;
            }
            .data-card {
                flex: 1 1 calc(50% - 8px);
                margin-bottom: 10px;
            }
            .control-section {
                flex-wrap: wrap;
            }
            .control-btn {
                flex: 1 1 calc(50% - 8px);
                margin-bottom: 10px;
            }
            /* 智能充放电模态框 */
            .modal-content {
                width: 80%;
                margin: 30px auto;
                padding: 24px;
            }
        }
        
        /* 大屏幕（桌面，769px+） */
        @media (min-width: 769px) {
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }
            .status-card,
            .data-card,
            .control-section,
            .bind-section,
            .car-list-section {
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
            }
        }
        /* 顶部状态卡片样式 */
        .status-card {
            background-color: var(--white);
            border-radius: 12rpx;
            padding: 40rpx 20rpx;
            margin-bottom: 20rpx;
            box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .status-value {
            font-size: 64rpx;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8rpx;
        }

        .status-label {
            font-size: 28rpx;
            color: var(--text-secondary);
            margin-bottom: 8rpx;
        }

        .status-desc {
            font-size: 24rpx;
            color: var(--text-light);
        }

        /* 数据卡片容器 */
        .data-cards {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20rpx;
        }

        .data-card {
            flex: 1;
            background-color: var(--white);
            border-radius: 12rpx;
            padding: 24rpx;
            margin-right: 10rpx;
            box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .data-card:last-child {
            margin-right: 0;
        }

        .data-value {
            font-size: 40rpx;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8rpx;
        }

        .data-label {
            font-size: 24rpx;
            color: var(--text-secondary);
        }

        /* 控制按钮区域 */
        .control-section {
            background-color: var(--white);
            border-radius: 12rpx;
            padding: 24rpx;
            margin-bottom: 20rpx;
            box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
        }

        .control-btn {
            flex: 1;
            margin-right: 10rpx;
        }

        .control-btn:last-child {
            margin-right: 0;
        }

        /* 绑定充电桩区域 */
        .bind-section {
            background-color: var(--white);
            border-radius: 12rpx;
            padding: 24rpx;
            margin-bottom: 20rpx;
            box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 16rpx;
        }

        .input {
            margin-bottom: 16rpx;
        }

        .bind-btn, .scan-btn {
            margin-bottom: 16rpx;
        }

        .station-info {
            font-size: 28rpx;
            color: var(--primary-color);
            margin-top: 8rpx;
        }

        /* 更新时间 */
        .update-time {
            font-size: 24rpx;
            color: var(--text-light);
            text-align: center;
            margin-top: 20rpx;
        }

        /* 加载提示 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40rpx;
            color: var(--text-light);
        }

        /* 错误提示 */
        .error {
            padding: 20rpx;
            background-color: rgba(245, 34, 45, 0.1);
            color: var(--error-color);
            border-radius: 8rpx;
            margin-bottom: 20rpx;
            font-size: 28rpx;
        }

        .subtitle {
            font-size: 32rpx;
            font-weight: 700;
            margin-bottom: 20rpx;
            color: #333;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 16rpx;
        }

        .input {
            width: 100%;
            padding: 20rpx;
            border: 1rpx solid #e8e8e8;
            border-radius: 8rpx;
            font-size: 28rpx;
            margin-bottom: 16rpx;
        }

        .bind-btn, .scan-btn {
            margin-bottom: 16rpx;
        }

        .station-info {
            font-size: 28rpx;
            color: #1a73e8;
            margin-top: 8rpx;
        }

        /* 智能充放电选项卡样式 */
        .tab-container {
            width: 100%;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20rpx;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .tab-btn {
            flex: 1;
            padding: 16rpx 0;
            background: none;
            border: none;
            font-size: 28rpx;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn.active {
            color: #1a73e8;
            border-bottom-color: #1a73e8;
            font-weight: 700;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 智能充放电按钮样式 */
        .action-btn.v2g-btn {
            background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
            color: white;
        }
        
        .action-btn.v2g-btn:hover {
            background: linear-gradient(135deg, #1557b0 0%, #3367d6 100%);
            transform: translateY(-2px);
        }
        
        /* 任务执行样式 */
        .countdown-tip {
            background-color: #fffde7;
            border-left: 4px solid #ffd700;
            padding: 16rpx;
            margin-bottom: 20rpx;
            display: flex;
            align-items: center;
        }
        .tip-icon {
            font-size: 32rpx;
            margin-right: 12rpx;
        }
        .tip-text {
            font-size: 28rpx;
            color: #666;
        }
        .task-card {
            background-color: #fff;
            border-radius: 12rpx;
            padding: 24rpx;
            margin-bottom: 20rpx;
            box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20rpx;
        }
        .card-title {
            font-size: 32rpx;
            font-weight: 700;
            color: #333;
        }
        .task-status {
            font-size: 28rpx;
            color: #1a73e8;
            background-color: #e8f0fe;
            padding: 8rpx 16rpx;
            border-radius: 20rpx;
        }
        .task-info {
            margin-bottom: 20rpx;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12rpx 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .label {
            font-size: 28rpx;
            color: #666;
        }
        .value {
            font-size: 28rpx;
            color: #333;
            font-weight: 500;
        }
        .instructions {
            background-color: #f5f5f5;
            border-radius: 8rpx;
            padding: 20rpx;
            margin-bottom: 20rpx;
        }
        .instructions-title {
            font-size: 28rpx;
            font-weight: 700;
            color: #333;
            margin-bottom: 12rpx;
            display: block;
        }
        .instructions-text {
            font-size: 26rpx;
            color: #666;
            margin-bottom: 8rpx;
            display: block;
        }
        .action-section {
            display: flex;
            flex-direction: column;
            gap: 16rpx;
        }
        .btn-icon {
            margin-right: 8rpx;
        }
        .btn-text {
            font-weight: 700;
        }

        /* 按钮样式 */
        .btn {
            width: 100%;
            padding: 24rpx;
            border: none;
            border-radius: 8rpx;
            font-size: 28rpx;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #1a73e8;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1557b0;
        }

        .btn-danger {
            background-color: #d93025;
            color: white;
        }

        .btn-danger:hover {
            background-color: #b3211a;
        }

        /* 更新时间 */
        .update-time {
            font-size: 24rpx;
            color: #999;
            text-align: center;
            margin-top: 20rpx;
        }

        /* 加载提示 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40rpx;
            color: #999;
        }

        /* 错误提示 */
        .error {
            padding: 20rpx;
            background-color: rgba(245, 34, 45, 0.1);
            color: #d93025;
            border-radius: 8rpx;
            margin-bottom: 20rpx;
            font-size: 28rpx;
        }

        /* 用户信息区域 */
        .user-info {
            background: white;
            border-radius: 12rpx;
            padding: 32rpx;
            margin-bottom: 20rpx;
            box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);
            color: #333;
        }
        .user-info::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 80%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        .user-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        .user-avatar {
            width: 88px;
            height: 88px;
            background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            font-weight: bold;
            margin-right: 20px;
            overflow: hidden;
            border: 4px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }
        .user-avatar:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 32px rgba(255, 255, 255, 0.4);
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #1a73e8;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1557b0;
        }
        .btn-secondary {
            background-color: #f1f3f4;
            color: #333;
        }
        .btn-secondary:hover {
            background-color: #e8eaed;
        }
        .user-details {
            flex: 1;
        }
        .user-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 6px;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }
        .user-phone {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            z-index: 1;
        }
        .user-tip {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
            font-style: italic;
        }
        .user-stats {
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 24px;
            position: relative;
            z-index: 1;
        }
        .stat-item {
            text-align: center;
            transition: transform 0.3s ease;
        }
        .stat-item:hover {
            transform: translateY(-5px);
        }
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: white;
            display: block;
            text-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }
        /* 信息卡片 */
        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            padding: 32px;
            margin: 24px;
            box-shadow: 0 12px 48px rgba(102, 126, 234, 0.4);
            color: white;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .info-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 60px rgba(102, 126, 234, 0.5);
        }
        .info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.15) 0%, transparent 50%);
        }
        .card-title {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .electricity-price {
            font-size: 64px;
            font-weight: 800;
            color: white;
            margin: 16px 0;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,0.9) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }
        
        /* 电价时段显示样式 */
        .price-type-display {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .price-type-label {
            font-size: 14px;
            color: #666;
        }
        
        .price-type {
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        .price-type.peak {
            background-color: rgba(255, 235, 238, 0.3);
            color: #D32F2F;
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3);
        }
        
        .price-type.valley {
            background-color: rgba(232, 245, 233, 0.3);
            color: #388E3C;
            box-shadow: 0 4px 12px rgba(56, 142, 60, 0.3);
        }
        
        .price-policy {
            margin-top: 12px;
            text-align: center;
            opacity: 0.8;
            color: rgba(255, 255, 255, 0.9);
        }
        /* 区域样式 */
        .cars-section, .action-buttons, .result-section, .history-section {
            margin-bottom: 32px;
            position: relative;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            position: relative;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -14px;
            left: 0;
            width: 40px;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        
        @media (max-width: 480px) {
            .section-title {
                font-size: 18px;
            }
        }
        .add-car-btn {
            width: 32px;
            height: 32px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
        }
        .add-car-btn:hover {
            background-color: #1557b0;
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* 车辆列表样式 */
        #cars-container {
            background-color: #f9f9f9;
            border-radius: 12px;
            padding: 16px;
            min-height: 100px;
        }
        /* 车辆列表容器 */
        .cars-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 24px;
        }
        
        @media (max-width: 480px) {
            .cars-container {
                padding: 16px;
                gap: 16px;
            }
        }
        
        .car-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(248,249,250,0.95) 100%);
            border-radius: 24px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            margin-bottom: 0;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border-left: 4px solid transparent;
        }
        
        .car-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.15), transparent);
            transition: left 0.6s ease;
            z-index: 0;
        }
        
        .car-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }
        
        .car-item:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25), 0 4px 16px rgba(0, 0, 0, 0.1);
            border-color: rgba(102, 126, 234, 0.7);
        }
        
        .car-item:hover::before {
            left: 100%;
        }
        
        .car-item:hover::after {
            transform: scaleX(1);
        }
        
        .car-item.disabled {
            opacity: 0.7;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            cursor: not-allowed;
        }
        
        .car-item.disabled:hover {
            transform: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        /* 根据车辆状态添加不同的左侧边框颜色 */
        .car-item[data-car-status="discharging"] {
            border-left-color: #28a745;
        }
        
        .car-item[data-car-status="charging"] {
            border-left-color: #007bff;
        }
        
        .car-item[data-car-status="idle"] {
            border-left-color: #ffc107;
        }
        
        .car-item[data-car-status="error"] {
            border-left-color: #dc3545;
        }
        
        .car-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 2;
        }
        
        .car-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        
        .car-item:hover .car-avatar {
            transform: scale(1.1);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.6);
        }
        
        .car-title {
            flex: 1;
        }
        
        .car-plate {
            font-size: 14px;
            color: #718096;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .car-status-indicator {
            margin-left: auto;
        }
        
        .status-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .status-badge.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .status-badge.inactive {
            background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }
        
        /* 车辆信息区域优化 */
        .car-info {
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }
        
        .car-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.9);
        }
        
        .car-item:hover .stat-item {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            font-size: 11px;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
        }
        
        /* 车辆操作区域优化 */
        .car-action {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding-top: 20px;
            border-top: 2px solid rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 2;
        }
        
        .mode-selector {
            display: flex;
            gap: 8px;
        }
        
        .mode-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .mode-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        .car-status {
            font-size: 14px;
            font-weight: 600;
            color: #718096;
        }
        
        .car-plate {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .car-status-indicator {
            margin-left: auto;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.active {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        
        .status-badge.inactive {
            background-color: #FFEBEE;
            color: #C62828;
        }
        
        .car-info {
            margin-bottom: 16px;
            flex: auto;
        }
        
        .car-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        
        .stat-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .stat-item:hover {
            background-color: rgba(255, 255, 255, 0.95);
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-item:hover::after {
            transform: scaleX(1);
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .soc-value, .health-value {
            font-weight: bold;
            color: #333;
        }
        
        .car-soc, .car-health {
            font-size: 14px;
            color: #666;
        }
        
        .soc-progress-container {
            width: 100%;
            height: 12px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .soc-progress-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 50%, #4CAF50 100%);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        .soc-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.4) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .car-action {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: 0;
            width: 100%;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            border: none;
            border-radius: 0;
            overflow: visible;
        }
        
        .mode-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .mode-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
        }
        
        .mode-btn:hover::before {
            left: 100%;
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .mode-icon {
            font-size: 16px;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .car-status {
            font-size: 14px;
            font-weight: 500;
            color: #666;
        }
        
        .no-cars {
            text-align: center;
            padding: 60px 20px;
            color: #888;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            border: 2px dashed rgba(0, 0, 0, 0.1);
            margin: 20px;
        }
        
        .no-cars-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }
        
        .no-cars span {
            display: block;
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .no-cars-text {
            font-size: 14px;
            color: #999;
            margin: 0;
        }
        .loading {
            text-align: center;
            padding: 32px;
            color: #666;
        }
        
        /* 骨架屏样式 */
        .skeleton-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px;
        }
        
        .skeleton-card {
            background-color: #f0f0f0;
            border-radius: 16px;
            padding: 24px;
            /* 应用骨架屏动画 */
            background-image: linear-gradient(
                90deg,
                rgba(240, 240, 240, 1) 25%,
                rgba(200, 200, 200, 0.3) 50%,
                rgba(240, 240, 240, 1) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .skeleton-title {
            width: 40%;
            height: 24px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .skeleton-content {
            width: 100%;
            height: 60px;
            background-color: rgba(0, 0, 0, 0.08);
            border-radius: 12px;
        }
        
        /* 骨架屏动画 */
        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        /* 旧的旋转加载动画，保留用于兼容性 */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 开关样式 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 32px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 34px;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background: linear-gradient(135deg, white 0%, #f0f0f0 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        input:checked + .slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: inset 0 2px 6px rgba(102, 126, 234, 0.3);
        }
        input:checked + .slider:before {
            transform: translateX(28px) scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        input:focus + .slider {
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }
        /* 操作按钮 */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 24px;
        }
        
        @media (max-width: 480px) {
            .action-buttons {
                grid-template-columns: 1fr;
                margin: 16px;
                gap: 12px;
            }
        }
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: none;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            gap: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }
        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .action-btn span {
            position: relative;
            z-index: 1;
        }
        .action-btn span:first-child {
            font-size: 28px;
        }
        .action-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
        }
        .discharge-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }
        .discharge-btn:hover {
            background: linear-gradient(135deg, #ff5252 0%, #d63031 100%);
        }
        .charge-btn {
            background: linear-gradient(135deg, #54a0ff 0%, #0984e3 100%);
            color: white;
        }
        .charge-btn:hover {
            background: linear-gradient(135deg, #3742fa 0%, #2d3436 100%);
        }
        .refresh-btn {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
        }
        .refresh-btn:hover {
            background: linear-gradient(135deg, #5f27cd 0%, #7e57c2 100%);
        }
        .history-btn {
            background: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);
            color: white;
        }
        .history-btn:hover {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
        }
        /* 结果样式 */
        .result-section {
            background: linear-gradient(135deg, rgba(232, 245, 233, 0.9) 0%, rgba(200, 230, 201, 0.9) 100%);
            border: 1px solid rgba(165, 214, 167, 0.5);
            border-radius: 20px;
            padding: 24px;
            animation: slideInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(165, 214, 167, 0.2);
        }
        
        @media (max-width: 480px) {
            .result-section {
                padding: 16px;
            }
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .result-title {
            font-size: 18px;
            font-weight: bold;
            color: #2e7d32;
        }
        .result-time {
            font-size: 12px;
            color: #666;
        }
        .result-stats {
            display: flex;
            justify-content: space-around;
        }
        .result-item {
            text-align: center;
        }
        .result-value {
            font-size: 28px;
            font-weight: bold;
            color: #1b5e20;
            display: block;
        }
        .result-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        /* 交易历史 */
        .history-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.9) 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .history-type {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .history-amount {
            font-size: 18px;
            font-weight: bold;
        }
        .amount-discharge {
            color: #28a745;
        }
        .amount-charge {
            color: #dc3545;
        }
        .history-details {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        /* 通知样式 */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            color: white;
            padding: 18px 24px;
            border-radius: 16px;
            z-index: 1000;
            font-size: 14px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
            animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1), fadeOut 0.3s ease 2.5s forwards;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            max-width: 350px;
            transform-origin: top right;
        }
        
        .notification.success {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.95) 0%, rgba(33, 136, 56, 0.95) 100%);
            box-shadow: 0 8px 32px rgba(40, 167, 69, 0.4);
        }
        
        .notification.error {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.95) 0%, rgba(200, 35, 51, 0.95) 100%);
            box-shadow: 0 8px 32px rgba(220, 53, 69, 0.4);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.95) 0%, rgba(255, 165, 0, 0.95) 100%);
            box-shadow: 0 8px 32px rgba(255, 193, 7, 0.4);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateX(50%) scale(0.8);
            }
        }
        
        @media (max-width: 480px) {
            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* 统计与可视化区域样式 */
        .stats-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.9) 100%);
            border-radius: 20px;
            padding: 24px;
            margin-top: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.2);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
        }
        
        .stat-card .stat-icon {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
            color: #667eea;
        }
        
        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-card .stat-label {
            font-size: 14px;
            color: rgba(0, 0, 0, 0.6);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .stat-change {
            font-size: 12px;
            margin-top: 8px;
            font-weight: 600;
        }
        
        .stat-change.positive {
            color: #28a745;
        }
        
        .stat-change.negative {
            color: #dc3545;
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card .stat-value {
                font-size: 28px;
            }
        }

        .stat-card {
            display: flex;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .stat-icon {
            font-size: 28px;
            margin-right: 12px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }

        .chart-container {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #power-chart {
            max-width: 100%;
            height: auto;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.95) 100%);
            margin: 8% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-100px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        /* 车辆放电信息模态框样式 */
        .car-basic-info {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .car-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-label {
            font-weight: 600;
            color: #667eea;
        }
        
        .info-value {
            color: #333;
        }
        
        .discharge-real-time {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .discharge-real-time h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #667eea;
            font-size: 18px;
        }
        
        .discharge-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-unit {
            font-size: 14px;
            color: #777;
        }
        
        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .discharge-progress {
            margin-top: 20px;
        }
        
        .progress-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-percentage {
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
            text-align: right;
        }
        
        .discharge-history {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .discharge-history h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #667eea;
            font-size: 18px;
        }
        
        #discharge-history-list {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .history-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .history-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .discharge-stats-summary {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            padding: 20px;
            border-radius: 15px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .summary-label {
            color: #666;
        }
        
        .summary-unit {
            font-size: 14px;
            color: #999;
        }

        .close-btn {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 4px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .close-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            background: rgba(0, 0, 0, 0.02);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .modal-footer .btn {
            padding: 12px 24px;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .modal-footer .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-footer .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4290 100%);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .modal-footer .btn-secondary {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
        }
        
        .modal-footer .btn-secondary:hover {
            background: rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* 移除重复的模态框样式，统一使用上面的响应式设计 */

        /* 头像设置样式 */
        .avatar-setting {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 8px;
        }
        .avatar-preview {
            width: 80px;
            height: 80px;
            background-color: #1a73e8;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        .avatar-preview:hover {
            transform: scale(1.05);
            border-color: #1a73e8;
        }
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            color: #333;
        }

        .form-group input::placeholder,
        .form-group select::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 1);
        }
        
        .form-group input:hover,
        .form-group select:hover {
            border-color: rgba(102, 126, 234, 0.4);
            background: rgba(255, 255, 255, 1);
        }

        .help-text {
            font-size: 14px;
            color: rgba(0, 0, 0, 0.6);
            margin-top: 8px;
            line-height: 1.4;
        }
        
        /* 验证码输入组样式 */
        .code-input-group {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        
        .code-input-group input {
            flex: 1;
        }
        
        .captcha-image {
            width: 120px;
            height: 52px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid rgba(102, 126, 234, 0.2);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .captcha-image:hover {
            border-color: rgba(102, 126, 234, 0.4);
            transform: scale(1.02);
        }
        
        /* 登录/注册切换样式 */
        .switch-mode {
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: rgba(0, 0, 0, 0.6);
        }
        
        .switch-mode a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .switch-mode a:hover {
            text-decoration: none;
            background: rgba(102, 126, 234, 0.1);
            color: #764ba2;
        }
        
        .switch-mode a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-50%);
        }
        
        .switch-mode a:hover::after {
            width: 100%;
        }

        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            cursor: pointer;
        }

        .btn-primary {
            background-color: #1a73e8;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1557b0;
        }

        .btn-cancel {
            background-color: #f5f5f5;
            color: #333;
        }

        .btn-cancel:hover {
            background-color: #e0e0e0;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        /* SOC进度条样式 */
        .soc-progress-container {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .soc-progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        /* 充电动画 */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .charging-animation {
            animation: pulse 1.5s infinite;
        }
        
        /* 历史记录样式 */
        .history-item {
            background-color: #fff;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .history-type {
            font-weight: bold;
            color: #333;
        }
        
        .history-amount {
            font-weight: bold;
            font-size: 16px;
        }
        
        .amount-discharge {
            color: #28a745;
        }
        
        .amount-charge {
            color: #dc3545;
        }
        
        .history-details {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        /* 电池健康度指示器 */
        .health-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 4px;
            display: inline-block;
        }
        
        .health-good {
            background-color: #28a745;
        }
        
        .health-medium {
            background-color: #ffc107;
        }
        
        .health-poor {
            background-color: #dc3545;
        }
        
        /* 下拉刷新样式 */
        .refresh-container {
            position: relative;
            overflow: hidden;
        }
        
        .pull-down-refresh {
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        /* 响应式设计 */
        @media (max-width: 480px) {
            body {
                padding: 0;
            }
            
            .container {
                border-radius: 0;
                box-shadow: none;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .user-stats {
                flex-direction: column;
                gap: 12px;
            }
            
            .user-stats > div {
                text-align: center;
            }
        }
        /* 响应式设计 */
        @media (max-width: 480px) {
            .container > div:not(.navbar) {
                padding: 16px;
            }
            .car-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .car-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .car-status-indicator {
                margin-left: 0;
            }
            .car-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            .car-action {
                margin-top: 16px;
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            .mode-selector {
                width: 100%;
                justify-content: space-between;
            }
            .mode-btn {
                flex: 1;
                justify-content: center;
            }
            .user-stats {
                flex-direction: column;
                gap: 16px;
            }
            .stat-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .result-stats {
                flex-direction: column;
                gap: 16px;
            }
            .result-item {
                text-align: left;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="navbar">
        <div class="navbar-title">V2G聚合平台</div>
        <div class="navbar-menu">
            <a href="index.html" class="navbar-link active">首页</a>
            <a href="cars.html" class="navbar-link">车辆管理</a>
            <a href="v2g.html" class="navbar-link">充放电控制</a>
            <a href="tasks.html" class="navbar-link">任务管理</a>
            <a href="settings.html" class="navbar-link">设置</a>
        </div>
        <div class="navbar-icon" id="userIcon">
            <span class="icon">👤</span>
        </div>
    </div>
    <div class="container">
            <!-- 顶部状态卡片 -->
            <div class="status-card">
                <div class="status-value"><text id="current-power">0</text>W</div>
                <div class="status-label">当前功率</div>
                <div class="status-desc" id="power-status">未连接</div>
            </div>

            <!-- 数据卡片容器 -->
            <div class="data-cards">
                <div class="data-card">
                    <div class="data-value" id="total-discharge">0.0 kWh</div>
                    <div class="data-label">累计放电量</div>
                </div>
                <div class="data-card">
                    <div class="data-value">¥<text id="today-income">0.00</text></div>
                    <div class="data-label">今日收益预估</div>
                </div>
            </div>

            <!-- 控制按钮区域 -->
            <div class="control-section">
                <button class="btn btn-primary control-btn" id="start-btn" onclick="startDischarge()">
                    开始放电
                </button>
                <button class="btn btn-danger control-btn" id="stop-btn" onclick="stopDischarge()">
                    停止
                </button>
            </div>

            <!-- 绑定充电桩区域 -->
            <div class="bind-section">
                <div class="subtitle">绑定充电桩</div>
                <div class="input-group">
                    <input class="input" placeholder="请输入充电桩编号" id="station-id" />
                    <button class="btn btn-primary bind-btn" onclick="bindStation()">
                        绑定
                    </button>
                    <button class="btn btn-primary scan-btn" onclick="scanCode()">
                        扫码绑定
                    </button>
                </div>
                <div id="station-info" class="station-info" style="display: none;">
                    当前绑定桩号：<text id="current-station">无</text>
                </div>
            </div>

            <!-- 实时数据更新提示 -->
            <div class="update-time">
                数据更新时间：<text id="update-time">无</text>
            </div>

            <!-- 加载提示 -->
            <div id="loading" class="loading" style="display: none;">
                <text>数据加载中...</text>
            </div>

            <!-- 错误提示 -->
            <div id="error" class="error" style="display: none;">
                <text id="error-message">加载失败</text>
            </div>
        </div>

        <!-- 车辆列表区域 -->
        <div class="cars-section">
            <div class="section-header">
                <div class="section-title">我的车辆</div>
                <button class="add-car-btn" onclick="showNotification('添加车辆功能开发中')">+</button>
            </div>
            <div id="cars-container">
                <div class="skeleton-container">
                    <!-- 状态卡片骨架屏 -->
                    <div class="skeleton-card">
                        <div class="skeleton-title"></div>
                        <div class="skeleton-content"></div>
                    </div>
                    <!-- 数据卡片骨架屏 -->
                    <div class="skeleton-card">
                        <div class="skeleton-title"></div>
                        <div class="skeleton-content"></div>
                    </div>
                </div>
                <div class="loading">
                    <span>加载中...</span>
                </div>
            </div>
        </div>

        <!-- 操作按钮区域 -->
        <div class="action-buttons">
            <button class="action-btn v2g-btn" onclick="showV2GModal()">
                <span>⚡🔌</span>
                <span>智能充放电</span>
            </button>
            <button class="action-btn v2g-btn" onclick="openBookingModal()">
                <span>📅</span>
                <span>预约放电</span>
            </button>
            <button class="action-btn refresh-btn" onclick="refreshData()">
                <span>🔄</span>
                <span>刷新数据</span>
            </button>
            <button class="action-btn history-btn" onclick="toggleHistory()">
                <span>📊</span>
                <span>交易记录</span>
            </button>
        </div>

        <!-- 统计与可视化区域 -->
        <div class="stats-section">
            <div class="section-header">
                <div class="section-title">运行统计</div>
            </div>
            <div class="stats-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">⚡</div>
                        <div class="stat-info">
                            <div class="stat-label">总放电量</div>
                            <div class="stat-value" id="total-discharge">0.0 kWh</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">💰</div>
                        <div class="stat-info">
                            <div class="stat-label">总收益</div>
                            <div class="stat-value" id="total-income">¥0.00</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🚗</div>
                        <div class="stat-info">
                            <div class="stat-label">活跃车辆</div>
                            <div class="stat-value" id="active-cars">0辆</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-info">
                            <div class="stat-label">交易次数</div>
                            <div class="stat-value" id="transaction-count">0次</div>
                        </div>
                    </div>
                </div>
                
                <!-- 实时数据图表容器 -->
                <div class="chart-container">
                    <canvas id="power-chart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- 登录模态框 -->
        <div id="login-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>用户登录</h3>
                    <span class="close-btn" onclick="closeLoginModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="login-phone">手机号码</label>
                        <input type="tel" id="login-phone" placeholder="请输入手机号码" maxlength="11">
                    </div>
                    <div class="form-group">
                        <label for="login-code">验证码</label>
                        <div class="code-input-group">
                            <input type="text" id="login-code" placeholder="请输入验证码" maxlength="6">
                            <button class="btn btn-secondary" id="get-login-code" onclick="sendLoginCode()">获取验证码</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-cancel" onclick="closeLoginModal()">取消</button>
                    <button class="btn btn-primary" onclick="loginWithPhoneCode()">登录</button>
                    <button class="btn btn-secondary" onclick="quickLogin()" style="margin-left: 10px;">快速登录</button>
                    <div class="switch-mode">
                        <span>还没有账号？</span>
                        <a href="javascript:void(0);" onclick="switchToRegister()">立即注册</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 注册模态框 -->
        <div id="register-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>用户注册</h3>
                    <span class="close-btn" onclick="closeRegisterModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="register-phone">手机号码</label>
                        <input type="tel" id="register-phone" placeholder="请输入手机号码" maxlength="11">
                    </div>
                    <div class="form-group">
                        <label for="register-code">验证码</label>
                        <div class="code-input-group">
                            <input type="text" id="register-code" placeholder="请输入验证码" maxlength="6">
                            <button class="btn btn-secondary" id="get-register-code" onclick="sendRegisterCode()">获取验证码</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="register-nickname">昵称</label>
                        <input type="text" id="register-nickname" placeholder="请输入昵称">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-cancel" onclick="closeRegisterModal()">取消</button>
                    <button class="btn btn-primary" onclick="registerWithPhoneCode()">注册</button>
                    <div class="switch-mode">
                        <span>已有账号？</span>
                        <a href="javascript:void(0);" onclick="switchToLogin()">立即登录</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用户设置模态框 -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>设置中心</h3>
                    <span class="close-btn" onclick="closeSettingsModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- 未登录状态 -->
                    <div id="settings-not-logged-in" class="settings-section" style="display: none;">
                        <div class="login-prompt">
                            <div class="login-prompt-icon">🔑</div>
                            <h4>请先登录</h4>
                            <p>登录后可享受更多功能和个性化设置</p>
                            <div class="login-buttons">
                                <button class="btn btn-primary" onclick="showLoginModal()">登录/注册</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 已登录状态 -->
                    <div id="settings-logged-in" class="settings-section">
                        <!-- 用户信息设置 -->
                        <div class="settings-group">
                            <h4>用户信息</h4>
                            <div class="form-group">
                                <label for="settings-avatar">头像</label>
                                <div class="avatar-setting">
                                    <div class="avatar-preview" id="avatar-preview">
                                        <span id="avatar-text">${currentUser ? currentUser.nickname.charAt(0) : 'U'}</span>
                                    </div>
                                    <input type="file" id="avatar-file" accept="image/*" style="display: none;">
                                    <button class="btn btn-secondary" onclick="document.getElementById('avatar-file').click()">更换头像</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="settings-nickname">昵称</label>
                                <input type="text" id="settings-nickname" placeholder="请输入昵称">
                            </div>
                            <div class="form-group">
                                <label for="settings-phone">手机号码</label>
                                <input type="tel" id="settings-phone" placeholder="手机号码" readonly>
                            </div>
                        </div>
                        
                        <!-- 账号管理 -->
                        <div class="settings-group">
                            <h4>账号管理</h4>
                            <div class="setting-item">
                                <div class="setting-label">修改密码</div>
                                <div class="setting-action">
                                    <button class="btn btn-link" onclick="showNotification('修改密码功能开发中')">修改</button>
                                </div>
                            </div>
                            <div class="setting-item">
                                <div class="setting-label">绑定微信</div>
                                <div class="setting-action">
                                    <button class="btn btn-link" onclick="showNotification('微信绑定功能开发中')">绑定</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 安全设置 -->
                        <div class="settings-group">
                            <h4>安全设置</h4>
                            <div class="setting-item">
                                <div class="setting-label">登录设备管理</div>
                                <div class="setting-action">
                                    <button class="btn btn-link" onclick="showNotification('设备管理功能开发中')">查看</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 关于 -->
                        <div class="settings-group">
                            <h4>关于</h4>
                            <div class="setting-item">
                                <div class="setting-label">版本信息</div>
                                <div class="setting-value">v1.0.0</div>
                            </div>
                        </div>
                        
                        <!-- 退出登录 -->
                        <div class="settings-group danger">
                            <button class="btn btn-danger" onclick="confirmLogout()">退出登录</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-cancel" onclick="closeSettingsModal()">关闭</button>
                    <button class="btn btn-primary" onclick="saveUserSettings()">保存设置</button>
                </div>
            </div>
        </div>

        <!-- 预约放电模态框 -->
        <div id="booking-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>V2G放电任务预约</h3>
                    <span class="close-btn" onclick="closeBookingModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="booking-form">
                        <!-- 车型选择 -->
                        <div class="form-item">
                            <label class="form-label">车型选择</label>
                            <select id="car-model" class="form-control">
                                <option value="比亚迪 汉 EV">比亚迪 汉 EV</option>
                                <option value="蔚来 ET5">蔚来 ET5</option>
                                <option value="小鹏 G6">小鹏 G6</option>
                                <option value="特斯拉 Model 3">特斯拉 Model 3</option>
                            </select>
                        </div>

                        <!-- 当前电量 -->
                        <div class="form-item">
                            <label class="form-label">当前电量</label>
                            <div class="slider-container">
                                <input type="range" id="battery-level" min="40" max="100" value="70" step="1">
                                <div class="slider-value" id="battery-value">70%</div>
                            </div>
                            <div class="safety-tip">⚠️ 为保护电池，电量需 ≥50%，放电后剩余 ≥30%</div>
                        </div>

                        <!-- 预约时间 -->
                        <div class="form-item">
                            <label class="form-label">预约时间</label>
                            <input type="datetime-local" id="reserve-time" class="form-control" required>
                        </div>

                        <!-- 放电时长 -->
                        <div class="form-item">
                            <label class="form-label">放电时长</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="duration" value="15" checked>
                                    <span>15分钟 (3.5kWh)</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="duration" value="30">
                                    <span>30分钟 (7kWh)</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-cancel" onclick="closeBookingModal()">取消</button>
                    <button class="btn btn-primary" id="submit-booking">预约 V2G 调度任务</button>
                </div>
            </div>
        </div>

        <!-- 任务执行模态框 -->
        <div id="execute-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>V2G 任务执行</h3>
                    <span class="close-btn" onclick="closeExecuteModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- 倒计时提示 -->
                    <div class="countdown-tip" id="countdown-tip" style="display: none;">
                        <span class="tip-icon">⏰</span>
                        <span class="tip-text">距离任务开始还有 <span id="countdown-text"></span></span>
                    </div>
                    
                    <!-- 任务详情卡片 -->
                    <div class="task-card">
                        <div class="card-header">
                            <span class="card-title">任务详情</span>
                            <span class="task-status" id="task-status">待开始</span>
                        </div>
                        
                        <div class="task-info">
                            <div class="info-item">
                                <span class="label">任务ID：</span>
                                <span class="value" id="task-id"></span>
                            </div>
                            <div class="info-item">
                                <span class="label">车型：</span>
                                <span class="value" id="task-car-model"></span>
                            </div>
                            <div class="info-item">
                                <span class="label">预约时间：</span>
                                <span class="value" id="task-scheduled-time"></span>
                            </div>
                            <div class="info-item">
                                <span class="label">放电时长：</span>
                                <span class="value" id="task-duration"></span> 分钟
                            </div>
                            <div class="info-item">
                                <span class="label">预计放电量：</span>
                                <span class="value" id="task-discharged-kwh"></span> kWh
                            </div>
                        </div>
                        
                        <!-- 执行说明 -->
                        <div class="instructions">
                            <span class="instructions-title">执行说明：</span>
                            <div class="instructions-text">• 请确保车辆已停稳并处于安全状态</div>
                            <div class="instructions-text">• 请确认车辆电量充足（建议≥50%）</div>
                            <div class="instructions-text">• 点击下方按钮开始放电</div>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="action-section">
                        <button class="btn btn-primary" id="start-discharge-btn" onclick="startDischargeTask()">
                            <span class="btn-icon">⚡</span>
                            <span class="btn-text">我已就位，开始放电</span>
                        </button>
                        <button class="btn btn-cancel" onclick="closeExecuteModal()">
                            <span class="btn-icon">←</span>
                            <span class="btn-text">返回</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 智能充放电模态框 -->
        <div id="v2g-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>智能充放电设置</h3>
                    <span class="close-btn" onclick="closeV2GModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- 选项卡切换 -->
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button class="tab-btn active" onclick="switchTab('discharge')">放电操作</button>
                            <button class="tab-btn" onclick="switchTab('charge')">充电操作</button>
                        </div>
                        
                        <!-- 放电设置 -->
                        <div id="discharge-tab" class="tab-content active">
                            <div class="form-group">
                                <label for="target-soc">目标SOC(%)</label>
                                <input type="number" id="target-soc" min="20" max="100" value="50">
                            </div>
                            <div class="form-group">
                                <label for="smart-mode">智能模式</label>
                                <select id="smart-mode">
                                    <option value="0">经济模式</option>
                                    <option value="1">平衡模式</option>
                                    <option value="2">性能模式</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="discharge-car">选择车辆</label>
                                <select id="discharge-car">
                                    <option value="auto">自动选择(推荐)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>智能模式说明</label>
                                <p class="help-text">智能模式将考虑电价、电池健康度和车辆状态，自动选择最优放电策略。</p>
                            </div>
                        </div>
                        
                        <!-- 充电设置 -->
                        <div id="charge-tab" class="tab-content">
                            <div class="form-group">
                                <label for="charge-amount">充电电量(kWh)</label>
                                <input type="number" id="charge-amount" min="1" max="50" value="10">
                            </div>
                            <div class="form-group">
                                <label for="charge-car">选择车辆</label>
                                <select id="charge-car">
                                    <option value="auto">自动选择(推荐)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-cancel" onclick="closeV2GModal()">取消</button>
                    <button class="btn btn-primary" onclick="executeV2GAction()">执行操作</button>
                </div>
            </div>
        </div>

        <!-- 车辆放电信息模态框 -->
        <div id="discharge-info-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>车辆放电信息</h3>
                    <span class="close-btn" onclick="closeDischargeInfoModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="car-basic-info">
                        <div class="car-info-item">
                            <span class="info-label">车型：</span>
                            <span id="discharge-car-model" class="info-value">-</span>
                        </div>
                        <div class="car-info-item">
                            <span class="info-label">车牌号：</span>
                            <span id="discharge-car-plate" class="info-value">-</span>
                        </div>
                    </div>
                    
                    <div class="discharge-real-time">
                        <h4>实时放电数据</h4>
                        <div class="discharge-stats">
                            <div class="stat-box">
                                <div class="stat-value" id="discharge-current-power">0</div>
                                <div class="stat-unit">W</div>
                                <div class="stat-label">当前功率</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="discharge-soc">0</div>
                                <div class="stat-unit">%</div>
                                <div class="stat-label">当前电量</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="discharge-available-energy">0</div>
                                <div class="stat-unit">kWh</div>
                                <div class="stat-label">可用能量</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="discharge-duration">0</div>
                                <div class="stat-unit">min</div>
                                <div class="stat-label">放电时长</div>
                            </div>
                        </div>
                        
                        <div class="discharge-progress">
                            <div class="progress-label">放电进度</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="discharge-progress-bar"></div>
                            </div>
                            <div class="progress-percentage" id="discharge-progress-percentage">0%</div>
                        </div>
                    </div>
                    
                    <div class="discharge-history">
                        <h4>近期放电记录</h4>
                        <div id="discharge-history-list">
                            <!-- 历史记录将通过JavaScript动态添加 -->
                        </div>
                    </div>
                    
                    <div class="discharge-stats-summary">
                        <div class="summary-item">
                            <span class="summary-label">今日放电量：</span>
                            <span id="discharge-today-total">0</span> <span class="summary-unit">kWh</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">本月放电量：</span>
                            <span id="discharge-month-total">0</span> <span class="summary-unit">kWh</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">累计放电量：</span>
                            <span id="discharge-total">0</span> <span class="summary-unit">kWh</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="startCarDischarge()">开始放电</button>
                    <button class="btn btn-secondary" onclick="closeDischargeInfoModal()">关闭</button>
                </div>
            </div>
        </div>

        <!-- 放电结果 -->
        <div class="result-section" id="result-section" style="display: none;">
            <div class="result-header">
                <div class="result-title">放电结果</div>
                <div class="result-time" id="result-time"></div>
            </div>
            <div class="result-stats">
                <div class="result-item">
                    <span class="result-value" id="result-kwh">0.00</span>
                    <div class="result-label">放电量(kWh)</div>
                </div>
                <div class="result-item">
                    <span class="result-value" id="result-amount">¥0.00</span>
                    <div class="result-label">收益</div>
                </div>
            </div>
        </div>

        <!-- 交易历史 -->
        <div class="history-section" id="history-section" style="display: none;">
            <div class="section-header">
                <div class="section-title">交易历史</div>
                <div class="navbar-icon" onclick="clearHistory()">🗑️</div>
            </div>
            <div id="history-container">
                <div class="no-cars">暂无交易记录</div>
            </div>
        </div>
    </div>

    <script src="utils/api.js"></script>
    <script src="scripts/common.js"></script>
    <script>
        // 用户认证相关全局变量
        let currentUser = null;
        let authToken = null;
        
        // 全局变量
        let currentCars = [];
        let transactionHistory = [];
        let electricityPrice = 1.20;
        let totalDischarge = 0;
        let totalIncome = 0;
        let isHistoryVisible = false;
        
        // 初始化页面
        function init() {
            // 模拟实时电价变化
            setInterval(updateElectricityPrice, 10000);
            
            // 每5秒检查一次车辆状态（用于自动模式）
            setInterval(checkAutoMode, 5000);
            
            // 检查本地存储的用户信息
            checkLocalUser();
            
            // 初始化下拉刷新
            initPullToRefresh();
            
            // 添加图表定时更新
            setInterval(() => {
                updateUserStats();
            }, 10000); // 每10秒更新一次统计和图表
            
            // 初始化图表（添加一些初始数据）
            for (let i = 0; i < 3; i++) {
                updateChartData();
            }
            
            // 启动数据同步机制 - 每5秒同步一次车辆数据
            setInterval(syncCarData, 5000);
        }
        
        // 同步车辆数据 - 确保演示页面与小程序保持一致
        async function syncCarData() {
            if (!authToken) return;
            
            try {
                // 从后端获取最新的车辆数据
                const response = await fetch('http://localhost:5000/api/cars/list', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    // 更新当前车辆数据
                    const updatedCars = result.cars.map(car => ({
                        ...car,
                        mode: car.mode || 'auto',
                        enabled: car.enabled !== undefined ? car.enabled : true,
                        soc: car.soc || Math.random() * 100,
                        battery_capacity: car.battery_capacity || 70,
                        battery_health: car.battery_health || 95,
                        license_plate: car.license_plate || `测试车牌${Math.floor(Math.random() * 10000)}`,
                        model: car.model || '测试车型',
                        status: car.status || 'idle'
                    }));
                    
                    // 如果有变化，更新显示
                    if (JSON.stringify(updatedCars) !== JSON.stringify(currentCars)) {
                        currentCars = updatedCars;
                        renderCars(updatedCars);
                        updateUserStats();
                        console.log('车辆数据已同步');
                    }
                }
            } catch (error) {
                console.error('同步车辆数据失败:', error);
            }
        }
        
        // 检查本地存储的用户信息
        function checkLocalUser() {
            const storedUser = localStorage.getItem('v2g_user');
            const storedToken = localStorage.getItem('v2g_token');
            
            if (storedUser && storedToken) {
                currentUser = JSON.parse(storedUser);
                authToken = storedToken;
                initUser();
                getCurrentPrice();
                getCars();
            } else {
                // 未登录，显示登录模态框
                showLoginModal();
                return;
            }
        }
        
        // 保存用户信息到本地存储
        function saveUserInfo(user, token) {
            currentUser = user;
            authToken = token;
            localStorage.setItem('v2g_user', JSON.stringify(user));
            localStorage.setItem('v2g_token', token);
        }
        
        // 清除本地存储的用户信息
        function clearUserInfo() {
            currentUser = null;
            authToken = null;
            localStorage.removeItem('v2g_user');
            localStorage.removeItem('v2g_token');
        }
        
        // 获取本地存储的用户信息
        function getUserInfo() {
            const userStr = localStorage.getItem('v2g_user');
            return userStr ? JSON.parse(userStr) : null;
        }
        
        // 显示登录模态框
        function showLoginModal() {
            const modal = document.getElementById('login-modal');
            modal.style.display = 'block';
        }
        
        // 关闭登录模态框
        function closeLoginModal() {
            const modal = document.getElementById('login-modal');
            modal.style.display = 'none';
        }
        
        // 显示注册模态框
        function showRegisterModal() {
            const modal = document.getElementById('register-modal');
            modal.style.display = 'block';
        }
        
        // 关闭注册模态框
        function closeRegisterModal() {
            const modal = document.getElementById('register-modal');
            modal.style.display = 'none';
        }
        
        // 显示用户设置模态框
        function showSettingsModal() {
            const modal = document.getElementById('settings-modal');
            const nicknameInput = document.getElementById('settings-nickname');
            const phoneInput = document.getElementById('settings-phone');
            const avatarPreview = document.getElementById('avatar-preview');
            const notLoggedInSection = document.getElementById('settings-not-logged-in');
            const loggedInSection = document.getElementById('settings-logged-in');
            const saveButton = document.querySelector('#settings-modal .btn-primary');
            
            if (currentUser) {
                // 已登录状态
                notLoggedInSection.style.display = 'none';
                loggedInSection.style.display = 'block';
                saveButton.style.display = 'block';
                
                nicknameInput.value = currentUser.nickname || '';
                phoneInput.value = currentUser.phone || '';
                
                // 设置头像预览
                avatarPreview.innerHTML = '';
                if (currentUser.avatar_url) {
                    const img = document.createElement('img');
                    img.src = currentUser.avatar_url;
                    img.alt = '头像';
                    avatarPreview.appendChild(img);
                } else {
                    const text = document.createElement('span');
                    text.textContent = currentUser.nickname ? currentUser.nickname.charAt(0) : 'U';
                    text.style.fontSize = '32px';
                    text.style.fontWeight = 'bold';
                    avatarPreview.appendChild(text);
                }
            } else {
                // 未登录状态
                notLoggedInSection.style.display = 'block';
                loggedInSection.style.display = 'none';
                saveButton.style.display = 'none';
            }
            
            modal.style.display = 'block';
        }
        
        // 关闭用户设置模态框
        function closeSettingsModal() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = 'none';
        }
        
        // 头像文件选择处理
        document.getElementById('avatar-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const avatarPreview = document.getElementById('avatar-preview');
                    avatarPreview.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.alt = '头像';
                    avatarPreview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 保存用户设置
        async function saveUserSettings() {
            const nickname = document.getElementById('settings-nickname').value;
            const avatarFile = document.getElementById('avatar-file').files[0];
            
            if (!nickname.trim()) {
                showNotification('昵称不能为空');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('nickname', nickname.trim());
                
                // 如果选择了新头像，添加到表单数据
                if (avatarFile) {
                    formData.append('avatar', avatarFile);
                }
                
                const response = await fetch('http://localhost:5000/api/user/info', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    // 更新当前用户信息
                    currentUser = data.data;
                    saveUserInfo(currentUser);
                    updateUserDisplay();
                    showNotification('设置保存成功');
                    closeSettingsModal();
                } else {
                    showNotification(data.message || '保存失败');
                }
            } catch (error) {
                console.error('保存设置失败:', error);
                showNotification('保存失败，请重试');
            }
        }
        
        // 切换到注册页面
        function switchToRegister() {
            closeLoginModal();
            showRegisterModal();
        }
        
        // 切换到登录页面
        function switchToLogin() {
            closeRegisterModal();
            showLoginModal();
        }
        
        // 发送登录验证码
        async function sendLoginCode() {
            const phone = document.getElementById('login-phone').value.trim();
            
            if (!phone || phone.length !== 11) {
                showNotification('请输入正确的手机号码');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/user/sms/code/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone })
                });
                
                const data = await response.json();
                if (data.code === 200) {
                    // 调试模式下，验证码会包含在返回数据中
                    if (data.code) {
                        showNotification(`验证码发送成功，验证码为：${data.code}（调试模式）`);

                    } else {
                        showNotification('验证码发送成功');
                    }
                    startCountdown('get-login-code');
                } else {
                    showNotification(data.error || '验证码发送失败');
                }
            } catch (error) {
                console.error('发送验证码失败:', error);
                showNotification('验证码发送失败，请检查网络连接');
            }
        }
        
        // 发送注册验证码
        async function sendRegisterCode() {
            const phone = document.getElementById('register-phone').value.trim();
            
            if (!phone || phone.length !== 11) {
                showNotification('请输入正确的手机号码');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/user/sms/code/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone })
                });
                
                const data = await response.json();
                if (data.code === 200) {
                    // 调试模式下，验证码会包含在返回数据中
                    if (data.code_value) {
                        showNotification(`验证码发送成功，验证码为：${data.code_value}（调试模式）`);
            
                    } else {
                        showNotification('验证码发送成功');
                    }
                    startCountdown('get-register-code');
                } else {
                    showNotification(data.error || '验证码发送失败');
                }
            } catch (error) {
                console.error('发送验证码失败:', error);
                showNotification('验证码发送失败，请检查网络连接');
            }
        }

        // 智能充电函数
        async function charge(target_soc, smart) {
            if (!authToken) {
                showNotification('请先登录');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/charge/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        target_soc: target_soc || 90,
                        smart: smart !== false
                    })
                });
                const data = await response.json();
        
                
                if (data.code === 200) {
                    showNotification('智能充电已开始');
                    // 延迟刷新数据
                    setTimeout(() => {
                        getCars();
                        getHistory();
                    }, 2000);
                } else {
                    showNotification(data.message || '智能充电失败');
                }
            } catch (error) {
                console.error('智能充电失败:', error);
                showNotification('智能充电失败');
            }
        }

        // 刷新数据
        function refreshData() {
            showNotification('正在刷新数据...');
            getCars();
            getHistory();
        }

        // 获取交易历史
        async function getHistory() {
            if (!authToken) return;
            
            try {
                const response = await fetch('http://localhost:5000/api/transaction/history', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();
        
                
                if (data.code === 200) {
                    renderHistory(data.transactions);
                } else {
                    showNotification(data.message || '获取交易历史失败');
                }
            } catch (error) {
                console.error('获取交易历史失败:', error);
            }
        }

        // 渲染交易历史
        function renderHistory(transactions) {
            const container = document.getElementById('history-container');
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = `
                    <div class="no-history">
                        <div class="no-history-icon">📊</div>
                        <span>暂无交易记录</span>
                        <p class="no-history-text">开始充放电操作后将显示历史记录</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            transactions.forEach(tx => {
                const isDischarge = tx.type === 'discharge';
                const amountClass = isDischarge ? 'amount-discharge' : 'amount-charge';
                const typeText = isDischarge ? '放电' : '充电';
                const amountPrefix = isDischarge ? '+' : '-';
                
                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <span class="history-type">${typeText}</span>
                            <span class="history-amount ${amountClass}">${amountPrefix}${tx.amount} kWh</span>
                        </div>
                        <div class="history-details">
                            <span>收益: ¥${tx.earning.toFixed(2)}</span>
                            <span>${new Date(tx.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // 更新用户统计
        function updateUserStats() {
            if (!currentCars.length) return;
            
            const totalEnergy = currentCars.reduce((sum, car) => {
                const capacity = car.battery_capacity || 70;
                return sum + (car.soc / 100) * capacity;
            }, 0);
            
            const totalCapacity = currentCars.reduce((sum, car) => {
                return sum + (car.battery_capacity || 70);
            }, 0);
            
            const avgSoc = totalCapacity > 0 ? (totalEnergy / totalCapacity) * 100 : 0;
            const activeCars = currentCars.filter(car => car.enabled).length;
            
            document.getElementById('total-energy').textContent = `${totalEnergy.toFixed(1)} kWh`;
            document.getElementById('avg-soc').textContent = `${avgSoc.toFixed(1)}%`;
            document.getElementById('active-cars').textContent = activeCars;
        }



        // 显示加载状态
        function showLoading() {
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.style.display = 'block';
            }
        }

        // 隐藏加载状态
        function hideLoading() {
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
        }

        // 显示通知
        function showNotification(message, duration = 3000) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, duration);
        }

        // 获取当前电价
        // 【优化】获取当前电价函数 - 增强版
        async function getCurrentPrice() {
            const priceElement = document.getElementById('current-price');
            const originalContent = priceElement ? priceElement.innerHTML : '';
            
            // 显示加载状态
            if (priceElement) {
                priceElement.innerHTML = '当前电价: 加载中...';
                priceElement.style.color = '#666';
            }
            
            try {
                // 【优化】添加请求超时处理
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                
                const response = await fetch('http://localhost:5000/api/discharge/price', {
                    method: 'GET',
                    headers: {
                        'Authorization': authToken ? `Bearer ${authToken}` : '',
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal // 添加信号支持超时
                });
                
                clearTimeout(timeoutId); // 清除超时定时器
                
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                
                const data = await response.json();
                
                // 【优化】更严格的响应数据验证
                if (data.code === 200 && typeof data.price === 'number') {
                    if (priceElement) {
                        priceElement.innerHTML = `当前电价: ${data.price.toFixed(2)}元/kWh`;
                        priceElement.style.color = '#333';
                        
                        // 【优化】添加价格变化动画效果
                        priceElement.style.transition = 'all 0.3s ease';
                        priceElement.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            priceElement.style.transform = 'scale(1)';
                        }, 300);
                    }
                    
                    // 【优化】保存电价数据到本地存储，用于离线显示
                    localStorage.setItem('v2g_last_price', data.price);
                    localStorage.setItem('v2g_last_price_time', new Date().toISOString());
                } else {
                    throw new Error('获取的电价数据格式不正确');
                }
            } catch (error) {
                console.error('获取电价失败:', error);
                
                if (priceElement) {
                    if (error.name === 'AbortError') {
                        priceElement.innerHTML = '当前电价: 请求超时';
                    } else {
                        priceElement.innerHTML = '当前电价: 获取失败';
                    }
                    priceElement.style.color = '#e74c3c';
                }
                
                // 【优化】使用本地存储的最后电价数据作为备用
                const lastPrice = localStorage.getItem('v2g_last_price');
                const lastTime = localStorage.getItem('v2g_last_price_time');
                
                if (lastPrice && priceElement) {
                    const timeDiff = Math.floor((new Date() - new Date(lastTime)) / (1000 * 60));
                    priceElement.innerHTML += `<br><span style="font-size: 12px; color: #999;">(上次更新: ${timeDiff}分钟前 ${parseFloat(lastPrice).toFixed(2)}元/kWh)</span>`;
                }
                
                // 【优化】添加重试按钮
                const retryBtn = document.createElement('button');
                retryBtn.textContent = '重试';
                retryBtn.style.cssText = `
                    margin-left: 10px;
                    padding: 4px 12px;
                    background: #3498db;
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-size: 12px;
                    cursor: pointer;
                `;
                retryBtn.onclick = () => {
                    retryBtn.remove();
                    getCurrentPrice();
                };
                
                if (priceElement && !priceElement.querySelector('button')) {
                    priceElement.appendChild(retryBtn);
                }
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 先从本地存储恢复用户信息
            const storedUser = localStorage.getItem('v2g_user');
            const storedToken = localStorage.getItem('v2g_token');
            
            if (storedUser && storedToken) {
                currentUser = JSON.parse(storedUser);
                authToken = storedToken;
                // 用户已登录，初始化用户信息
                initUser();
                getCurrentPrice();
                getCars(); // 获取车辆数据
            } else {
                // 用户未登录，显示登录模态框
                showLoginModal();
            }
            
            initPullToRefresh();
            
            // 定时刷新数据
            setInterval(() => {
                if (authToken) {
                    getCurrentPrice();
                    checkAutoMode();
                }
            }, 60000); // 每分钟检查一次
            
            // 定时刷新车辆数据
            setInterval(() => {
                if (authToken) {
                    getCars();
                }
            }, 30000); // 每30秒刷新一次
        });

        // 初始化用户
        async function initUser() {
            const userInfoDiv = document.getElementById('user-info');
            if (!userInfoDiv) {
                return; // 如果元素不存在，直接返回
            }
            
            if (!authToken) {
                userInfoDiv.innerHTML = `
                    <button onclick="showLoginModal()" class="login-btn">登录/注册</button>
                `;
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/user/info', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (data.code === 200) {
                    currentUser = data.user;
                    
                    // 构建头像HTML
                    let avatarHtml = '';
                    if (currentUser.avatar_url) {
                        avatarHtml = `<img src="${currentUser.avatar_url}" alt="头像" class="avatar-img">`;
                    } else {
                        avatarHtml = currentUser.nickname.charAt(0);
                    }
                    
                    // 格式化手机号（隐藏中间四位）
                    const formattedPhone = currentUser.phone ? currentUser.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2') : '';
                    
                    userInfoDiv.innerHTML = `
                        <div class="user-header">
                            <div class="user-avatar">${avatarHtml}</div>
                            <div class="user-details">
                                <div class="user-name">${currentUser.nickname}</div>
                                <div class="user-phone">${formattedPhone}</div>
                                <div class="user-tip">点击右上角设置图标管理账号</div>
                            </div>
                        </div>`;
                    getCars(); // 获取车辆信息
                } else {
                    // 检查是否是演示用户
                    const localUser = getUserInfo();
                    if (localUser && localUser.user_id === 'demo_user_1') {
                        // 演示用户，继续使用本地存储的信息
                        currentUser = localUser;
                        
                        // 构建头像HTML
                        let avatarHtml = '';
                        if (currentUser.avatar_url) {
                            avatarHtml = `<img src="${currentUser.avatar_url}" alt="头像" class="avatar-img">`;
                        } else {
                            avatarHtml = currentUser.nickname.charAt(0);
                        }
                        
                        // 格式化手机号（隐藏中间四位）
                        const formattedPhone = currentUser.phone ? currentUser.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2') : '';
                        
                        userInfoDiv.innerHTML = `
                            <div class="user-header">
                                <div class="user-avatar">${avatarHtml}</div>
                                <div class="user-details">
                                    <div class="user-name">${currentUser.nickname}</div>
                                    <div class="user-phone">${formattedPhone}</div>
                                    <div class="user-tip">点击右上角设置图标管理账号</div>
                                </div>
                            </div>`;
                        getCars(); // 获取车辆信息
                    } else {
                        console.error('获取用户信息失败:', data.error);
                        showLoginModal();
                    }
                }
            } catch (error) {
                console.error('初始化用户失败:', error);
                
                // 检查是否是演示用户
                const localUser = getUserInfo();
                if (localUser && localUser.user_id === 'demo_user_1') {
                    // 演示用户，继续使用本地存储的信息
                    currentUser = localUser;
                    
                    // 构建头像HTML
                    let avatarHtml = '';
                    if (currentUser.avatar_url) {
                        avatarHtml = `<img src="${currentUser.avatar_url}" alt="头像" class="avatar-img">`;
                    } else {
                        avatarHtml = currentUser.nickname.charAt(0);
                    }
                    
                    // 格式化手机号（隐藏中间四位）
                    const formattedPhone = currentUser.phone ? currentUser.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2') : '';
                    
                    userInfoDiv.innerHTML = `
                        <div class="user-header">
                            <div class="user-avatar">${avatarHtml}</div>
                            <div class="user-details">
                                <div class="user-name">${currentUser.nickname}</div>
                                <div class="user-phone">${formattedPhone}</div>
                                <div class="user-tip">点击右上角设置图标管理账号</div>
                            </div>
                        </div>`;
                    getCars(); // 获取车辆信息
                } else {
                    showLoginModal();
                }
            }
        }

        // 退出登录
        function logout() {
            clearUserInfo();
            showNotification('已退出登录');
            initUser();
        }
        


        // 渲染车辆列表
        function renderCars(cars) {
            const container = document.getElementById('cars-container');
            
            if (cars.length === 0) {
                container.innerHTML = `
                    <div class="no-cars">
                        <div class="no-cars-icon">🚗</div>
                        <span>暂无车辆数据</span>
                        <p class="no-cars-text">登录后即可查看和管理您的车辆</p>
                    </div>
                `;
                return;
            }
            
            // 使用文档片段减少DOM操作次数，提高渲染性能
            const fragment = document.createDocumentFragment();
            
            cars.forEach(car => {
                // 使用更合理的健康度计算，优先使用后端返回的battery_health值
                const health = car.battery_health || calculateBatteryHealth(car.soc);
                const socColor = getSocColor(car.soc);
                const healthClass = getHealthClass(health);
                const batteryCapacity = car.battery_capacity || 70; // 默认70kWh
                const availableEnergy = (car.soc / 100) * batteryCapacity;
                
                // 创建车辆元素
                const carItem = document.createElement('div');
                carItem.className = `car-item ${car.enabled ? '' : 'disabled'}`;
                carItem.dataset.carId = car.car_id; // 添加data-car-id属性以便直接选择
                carItem.dataset.carStatus = car.status || 'idle'; // 添加data-car-status属性
                carItem.onclick = () => showCarDischargeInfo(car); // 添加点击事件
                
                carItem.innerHTML = `
                    <div class="car-header">
                        <div class="car-avatar">
                            <span class="car-icon">🚗</span>
                        </div>
                        <div class="car-title">
                            <span class="car-model">${car.model || '未知车型'}</span>
                            <span class="car-plate">${car.license_plate || '未知牌照'}</span>
                        </div>
                        <div class="car-status-indicator">
                            <span class="status-badge ${car.enabled ? 'active' : 'inactive'}">
                                ${car.enabled ? '在线' : '离线'}
                            </span>
                        </div>
                    </div>
                    <div class="car-info">
                        <div class="car-stats-grid">
                            <div class="stat-item">
                                <div class="stat-label">电量</div>
                                <div class="stat-value" style="color: ${socColor}">${parseFloat(car.soc).toFixed(1)}%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">健康度</div>
                                <div class="stat-value">${parseFloat(health).toFixed(1)}%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">可用能量</div>
                                <div class="stat-value">${availableEnergy.toFixed(1)} kWh</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">电池容量</div>
                                <div class="stat-value">${parseFloat(batteryCapacity).toFixed(1)} kWh</div>
                            </div>
                        </div>
                        <div class="soc-progress-container">
                            <div class="soc-progress-bar" 
                                 style="width: ${car.soc}%; background-color: ${socColor}"></div>
                        </div>
                    </div>
                    <div class="car-action">
                        <div class="mode-selector">
                            <button class="mode-btn ${car.mode === 'auto' ? 'active' : ''}" 
                                    onclick="setCarMode(${car.car_id}, 'auto')">
                                <i class="mode-icon auto">🤖</i> 自动
                            </button>
                            <button class="mode-btn ${car.mode === 'manual' ? 'active' : ''}" 
                                    onclick="setCarMode(${car.car_id}, 'manual')">
                                <i class="mode-icon manual">👤</i> 手动
                            </button>
                        </div>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" ${car.enabled ? 'checked' : ''} 
                                       onchange="toggleCarStatus(${car.car_id}, this.checked)">
                                <span class="slider"></span>
                            </label>
                            <span class="car-status">${car.enabled ? '已启用' : '已禁用'}</span>
                        </div>
                    </div>
                `;
                
                // 将车辆元素添加到文档片段
                fragment.appendChild(carItem);
            });
            
            // 一次性将文档片段添加到容器中，减少DOM操作次数
            container.innerHTML = '';
            container.appendChild(fragment);
        }
        
        // 获取SOC颜色
        function getSocColor(soc) {
            if (soc > 60) return '#28a745'; // 绿色
            if (soc > 30) return '#ffc107'; // 黄色
            return '#dc3545'; // 红色
        }
        
        // 获取
        
        // 验证码倒计时
        function startCountdown(buttonId) {
            const button = document.getElementById(buttonId);
            const originalText = button.textContent;
            let countdown = 60;
            
            button.disabled = true;
            button.style.opacity = '0.6';
            
            const timer = setInterval(() => {
                countdown--;
                button.textContent = `${countdown}秒后重试`;
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.textContent = originalText;
                }
            }, 1000);
        }
        
        // 快速登录功能（用于演示）
        function quickLogin() {
            // 创建模拟用户信息
            const mockUser = {
                user_id: 'demo_user_1',
                openid: 'demo_user_', // 确保以'demo_user_'开头，符合后端DEBUG模式的token验证要求
                nickname: '演示用户',
                phone: '13800138000',
                avatar_url: '',
                total_discharge_amount: 12500,
                total_income: 2500,
                level: 5
            };
            
            // 生成符合后端格式的模拟token: {openid}:{timestamp}:{token_id}:{signature}
            const timestamp = Math.floor(Date.now() / 1000);
            const token_id = 'demo_token_' + Date.now();
            const signature = 'demo_signature'; // 演示环境，签名可以是任意值
            const mockToken = `${mockUser.openid}:${timestamp}:${token_id}:${signature}`;
            
            // 保存用户信息和token
            saveUserInfo(mockUser, mockToken);
            
            // 关闭登录模态框
            closeLoginModal();
            
            // 显示登录成功通知
            showNotification('快速登录成功');
            
            // 初始化用户信息
            initUser();
            
            // 初始化页面数据
            updatePowerStatus();
            updateTime();
        }
        
        // 开始放电
        function startDischarge() {
            const stationId = document.getElementById('station-id').value;
            if (!stationId) {
                showNotification('请先绑定充电桩');
                return;
            }
            
            // 更新状态
            document.getElementById('power-status').textContent = '放电中';
            document.getElementById('power-status').style.color = '#1a73e8';
            document.getElementById('current-power').textContent = Math.floor(Math.random() * 3000 + 1000); // 1000-4000W
            
            // 更新按钮状态
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            
            showNotification('开始放电');
            updateTime();
        }
        
        // 停止放电
        function stopDischarge() {
            // 更新状态
            document.getElementById('power-status').textContent = '已停止';
            document.getElementById('power-status').style.color = '#666';
            document.getElementById('current-power').textContent = '0';
            
            // 更新按钮状态
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            
            showNotification('停止放电');
            updateTime();
        }
        
        // 扫码绑定
        function scanCode() {
            // 模拟扫码功能
            const stationId = prompt('请输入扫码得到的充电桩编号：', 'station001');
            
            if (stationId) {
                // 将扫码得到的stationId填入输入框
                document.getElementById('station-id').value = stationId;
                // 调用绑定函数
                bindStation();
            } else {
                showNotification('扫码失败，请重试');
            }
        }
        
        // 绑定充电桩
        function bindStation() {
            const stationId = document.getElementById('station-id').value;
            if (!stationId) {
                showNotification('请输入充电桩编号');
                return;
            }
            
            // 保存充电桩编号
            localStorage.setItem('stationId', stationId);
            
            // 更新显示
            document.getElementById('current-station').textContent = stationId;
            document.getElementById('station-info').style.display = 'block';
            
            showNotification('充电桩绑定成功');
        }
        
        // 更新功率状态
        function updatePowerStatus() {
            const isDischarging = Math.random() > 0.5;
            if (isDischarging) {
                document.getElementById('power-status').textContent = '放电中';
                document.getElementById('power-status').style.color = '#1a73e8';
                document.getElementById('current-power').textContent = Math.floor(Math.random() * 3000 + 1000); // 1000-4000W
                document.getElementById('start-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
            } else {
                document.getElementById('power-status').textContent = '未连接';
                document.getElementById('power-status').style.color = '#666';
                document.getElementById('current-power').textContent = '0';
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
            }
        }
        
        // 更新时间
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN');
            document.getElementById('update-time').textContent = timeString;
        }
        
        // 初始化页面数据
        function initPageData() {
            // 加载保存的充电桩编号
            const savedStationId = localStorage.getItem('stationId');
            if (savedStationId) {
                document.getElementById('station-id').value = savedStationId;
                document.getElementById('current-station').textContent = savedStationId;
                document.getElementById('station-info').style.display = 'block';
            }
            
            // 更新功率状态
            updatePowerStatus();
            
            // 更新时间
            updateTime();
            
            // 每秒更新时间
            setInterval(updateTime, 1000);
        }
        
        // 页面加载完成后初始化数据
        document.addEventListener('DOMContentLoaded', function() {
            initPageData();
        });
        
        // 手机号验证码登录
        async function loginWithPhoneCode() {
            const phone = document.getElementById('login-phone').value;
            const code = document.getElementById('login-code').value;
            
            if (!phone || phone.length !== 11) {
                showNotification('请输入正确的手机号码');
                return;
            }
            
            if (!code || code.length !== 6) {
                showNotification('请输入6位验证码');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/user/login/phone-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone, code })
                });
                
                const data = await response.json();
                if (response.ok) {
                    saveUserInfo(data.user, data.token);
                    closeLoginModal();
                    showNotification('登录成功');
                    initUser();
                } else {
                    showNotification(data.error || '登录失败');
                }
            } catch (error) {
                console.error('登录失败:', error);
                showNotification('登录失败，请检查网络连接');
            }
        }
        
        // 手机号验证码注册
        async function registerWithPhoneCode() {
            const phone = document.getElementById('register-phone').value;
            const code = document.getElementById('register-code').value;
            const nickname = document.getElementById('register-nickname').value || 'V2G用户';
            
            if (!phone || phone.length !== 11) {
                showNotification('请输入正确的手机号码');
                return;
            }
            
            if (!code || code.length !== 6) {
                showNotification('请输入6位验证码');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/user/register/phone-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone, code, nickname })
                });
                
                const data = await response.json();
                if (response.ok) {
                    saveUserInfo(data.user, data.token);
                    closeRegisterModal();
                    showNotification('注册成功');
                    initUser();
                } else {
                    showNotification(data.error || '注册失败');
                }
            } catch (error) {
                console.error('注册失败:', error);
                showNotification('注册失败，请检查网络连接');
            }
        }
        
        // 检查自动模式
        async function checkAutoMode() {
            const autoCars = currentCars.filter(car => car.enabled && car.mode === 'auto');
            if (autoCars.length === 0) return;
            
            // 检查是否有车辆SOC超过70%，可以自动放电
            const dischargeCandidates = autoCars.filter(car => car.soc > 70);
            if (dischargeCandidates.length > 0) {
                // 自动放电（只调用一次API）
                await discharge();
            }
        }
        
        // 初始化下拉刷新
        function initPullToRefresh() {
            let startY;
            let isDragging = false;
            const container = document.querySelector('.container');
            
            container.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    startY = e.touches[0].clientY;
                    isDragging = true;
                }
            }, { passive: true });
            
            container.addEventListener('touchmove', (e) => {
                if (isDragging && window.scrollY === 0) {
                    const currentY = e.touches[0].clientY;
                    const diff = currentY - startY;
                    
                    if (diff > 0) {
                        e.preventDefault();
                        const pullHeight = Math.min(diff * 0.5, 100);
                        container.style.transform = `translateY(${pullHeight}px)`;
                    }
                }
            }, { passive: false });
            
            container.addEventListener('touchend', (e) => {
                if (isDragging) {
                    const currentY = e.changedTouches[0].clientY;
                    const diff = currentY - startY;
                    
                    container.style.transform = 'translateY(0)';
                    container.style.transition = 'transform 0.3s ease';
                    
                    if (diff > 50) {
                        // 触发刷新
                        refreshData();
                    }
                    
                    setTimeout(() => {
                        container.style.transition = '';
                    }, 300);
                    
                    isDragging = false;
                }
            }, { passive: true });
        }

        // 退出登录
        function logout() {
            clearUserInfo();
            showNotification('已退出登录');
            initUser();
        }
        
        // 确认退出登录
        function confirmLogout() {
            if (confirm('确定要退出登录吗？')) {
                logout();
                closeSettingsModal();
            }
        }
        
        // 更新用户信息显示
        function updateUserDisplay() {
            const userInfoDiv = document.getElementById('user-info');
            if (!userInfoDiv) return;
            
            // 从localStorage获取最新用户信息
            const currentUser = getUserInfo();
            if (!currentUser) {
                userInfoDiv.innerHTML = `
                    <button onclick="showLoginModal()" class="login-btn">登录/注册</button>
                `;
                return;
            }
            
            // 构建头像HTML
            let avatarHtml = '';
            if (currentUser.avatar_url) {
                avatarHtml = `<img src="${currentUser.avatar_url}" alt="头像" class="avatar-img">`;
            } else {
                avatarHtml = currentUser.nickname.charAt(0);
            }
            
            // 格式化手机号（隐藏中间四位）
            const formattedPhone = currentUser.phone ? currentUser.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2') : '';
            
            userInfoDiv.innerHTML = `
                <div class="user-header">
                    <div class="user-avatar">${avatarHtml}</div>
                    <div class="user-details">
                        <div class="user-name">${currentUser.nickname}</div>
                        <div class="user-phone">${formattedPhone}</div>
                        <div class="user-tip">点击右上角设置图标管理账号</div>
                    </div>
                </div>`;
        }
        
        // 获取车辆列表
        async function getCars() {
    
            if (!authToken) {
                showNotification('请先登录');
                hideLoading();
                return;
            }
            
    
            showLoading();
            try {
                const response = await fetch('http://localhost:5000/api/cars/list', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const result = await response.json();
        
                
                if (result.code === 200) {
            
                    // 为车辆添加默认属性
                    const carsWithMode = result.cars.map(car => ({
                        ...car,
                        mode: car.mode || 'auto',
                        enabled: car.enabled !== undefined ? car.enabled : true,
                        soc: car.soc || Math.random() * 100, // 随机电量百分比
                        battery_capacity: car.battery_capacity || 70, // 默认70kWh
                        battery_health: car.battery_health || 95, // 默认95%健康度
                        license_plate: car.license_plate || `测试车牌${Math.floor(Math.random() * 10000)}`, // 随机车牌
                        model: car.model || '测试车型', // 默认车型
                        status: car.status || 'idle' // 默认状态
                    }));
                    
            
                    currentCars = carsWithMode;
                    renderCars(carsWithMode);
                    updateUserStats();
                } else {
                    console.error('获取车辆列表失败:', result.message);
                    showNotification(result.message || '获取车辆列表失败');
                    renderCars([]);
                }
            } catch (error) {
                console.error('获取车辆列表异常:', error);
                showNotification('获取车辆列表失败');
                renderCars([]);
            } finally {
                hideLoading();
            }
        }


        
        // 获取SOC颜色
        function getSocColor(soc) {
            if (soc > 60) return '#28a745'; // 绿色
            if (soc > 30) return '#ffc107'; // 黄色
            return '#dc3545'; // 红色
        }
        
        // 获取健康度类别
        function getHealthClass(health) {
            if (health > 90) return 'health-good';
            if (health > 70) return 'health-medium';
            return 'health-poor';
        }

        // 切换车辆状态
        async function toggleCarStatus(carId, enabled) {
            if (!authToken) {
                showNotification('请先登录');
                return;
            }
            
            // 获取当前车辆元素，以便直接更新UI
            const carElement = document.querySelector(`[data-car-id="${carId}"]`);
            
            try {
                const response = await fetch('http://localhost:5000/api/cars/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        car_id: carId,
                        status: enabled ? 'active' : 'inactive',
                        enabled: enabled // 将enabled状态也同步到后端
                    })
                });
                const data = await response.json();
        
                
                if (data.code === 200) {
                    // 更新本地车辆数据
                    const carIndex = currentCars.findIndex(car => car.car_id === carId);
                    if (carIndex !== -1) {
                        currentCars[carIndex].enabled = enabled;
                        currentCars[carIndex].status = enabled ? 'active' : 'inactive';
                        
                        // 如果找到了车辆元素，直接更新UI而不是重新渲染整个列表
                        if (carElement) {
                            const statusElement = carElement.querySelector('.car-status');
                            const checkboxElement = carElement.querySelector('.toggle-switch input');
                            
                            if (statusElement) {
                                statusElement.textContent = enabled ? '已启用' : '已禁用';
                            }
                            if (checkboxElement) {
                                checkboxElement.checked = enabled;
                            }
                        } else {
                            // 如果没有找到元素，才重新渲染整个列表
                            renderCars(currentCars);
                        }
                    }
                    
                    showNotification(`${enabled ? '车辆已启用' : '车辆已禁用'}`);
                } else {
                    showNotification(data.message || '切换车辆状态失败');
                    // 只有在后端返回错误时才重新获取车辆列表
                    getCars();
                }
            } catch (error) {
                console.error('切换车辆状态失败:', error);
                showNotification('切换车辆状态失败');
                // 在网络错误时恢复UI状态
                if (carElement) {
                    const checkboxElement = carElement.querySelector('.toggle-switch input');
                    if (checkboxElement) {
                        checkboxElement.checked = !enabled;
                    }
                }
            }
        }

        // 设置车辆模式
        async function setCarMode(carId, mode) {
            // 获取当前车辆元素，以便直接更新UI
            const carElement = document.querySelector(`[data-car-id="${carId}"]`);
            
            // 更新本地车辆数据
            const carIndex = currentCars.findIndex(car => car.car_id === carId);
            if (carIndex !== -1) {
                // 先更新本地状态并刷新UI
                currentCars[carIndex].mode = mode;
                
                // 如果找到了车辆元素，直接更新UI而不是重新渲染整个列表
                if (carElement) {
                    // 更新模式按钮的激活状态
                    const autoBtn = carElement.querySelector('.mode-btn:nth-child(1)');
                    const manualBtn = carElement.querySelector('.mode-btn:nth-child(2)');
                    
                    if (autoBtn && manualBtn) {
                        autoBtn.classList.toggle('active', mode === 'auto');
                        manualBtn.classList.toggle('active', mode === 'manual');
                    }
                } else {
                    // 如果没有找到元素，才重新渲染整个列表
                    renderCars(currentCars);
                }
                
                showNotification(`车辆模式已切换为${mode === 'auto' ? '自动' : '手动'}`);
                
                // 异步同步到后端，避免阻塞UI更新
                try {
                    const response = await fetch('http://localhost:5000/api/cars/update', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            car_id: carId,
                            mode: mode
                        })
                    });
                    const data = await response.json();
                    if (data.code !== 200) {
                        console.error('同步车辆模式到后端失败:', data);
                        // 可以选择在失败时显示通知，但不要回滚UI更新
                    }
                } catch (error) {
                    console.error('同步车辆模式到后端失败:', error);
                }
            }
        }

        // 智能放电函数
        async function discharge(target_soc, smart, carId) {
            if (!authToken) {
                showNotification('请先登录');
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/api/discharge/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        car_id: carId,
                        target_soc: target_soc,
                        smart: smart
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => {});
                    throw new Error(errorData?.error || '放电请求失败');
                }
                
                const data = await response.json();
        
                
                // 获取transaction数据
                const transaction = data.transaction;
                
                // 检查是否有车辆可以放电
                if (!transaction || transaction.discharge_amount === 0 || transaction.income === 0) {
                    showNotification('没有可放电的车辆');
                    return;
                }
                
                // 更新统计数据
                const kwh = transaction.discharge_amount;
                const amount = transaction.income;
                totalDischarge += kwh;
                totalIncome += amount;
                
                // 记录交易
                const newTransaction = {
                    id: Date.now(),
                    type: 'discharge',
                    kwh: kwh,
                    amount: amount,
                    timestamp: new Date().toLocaleString()
                };
                transactionHistory.unshift(newTransaction);
                
                // 显示结果 - 创建兼容的数据结构
                showDischargeResult({kwh: kwh, amount: amount});
                
                // 更新车辆列表
                await getCars();
                
                // 更新交易记录显示
                if (isHistoryVisible) {
                    renderHistory();
                }
                
                showNotification('放电成功');
            } catch (error) {
                console.error('放电失败:', error);
                showNotification('放电失败: ' + error.message);
            }
        }

        // 当前选中的选项卡
        let currentTab = 'discharge';
        
        // 显示智能充放电模态框
        function showV2GModal() {
            const modal = document.getElementById('v2g-modal');
            
            // 初始化车辆选择下拉框
            const chargeCarSelect = document.getElementById('charge-car');
            const dischargeCarSelect = document.getElementById('discharge-car');
            
            // 处理充电车辆选择框
            const chargeAutoOption = chargeCarSelect.querySelector('option[value="auto"]');
            chargeCarSelect.innerHTML = '';
            chargeCarSelect.appendChild(chargeAutoOption);
            
            // 处理放电车辆选择框
            const dischargeAutoOption = dischargeCarSelect.querySelector('option[value="auto"]');
            dischargeCarSelect.innerHTML = '';
            dischargeCarSelect.appendChild(dischargeAutoOption);
            
            // 添加启用的车辆选项
            const enabledCars = currentCars.filter(car => car.enabled);
            enabledCars.forEach(car => {
                // 为充电选择框添加选项
                const chargeOption = document.createElement('option');
                chargeOption.value = car.id;
                chargeOption.textContent = `${car.model} (SOC: ${car.soc}%)`;
                chargeCarSelect.appendChild(chargeOption);
                
                // 为放电选择框添加选项
                const dischargeOption = document.createElement('option');
                dischargeOption.value = car.id;
                dischargeOption.textContent = `${car.model} (SOC: ${car.soc}%)`;
                dischargeCarSelect.appendChild(dischargeOption);
            });
            
            modal.style.display = 'block';
        }

        // 关闭智能充放电模态框
        function closeV2GModal() {
            const modal = document.getElementById('v2g-modal');
            modal.style.display = 'none';
        }
        
        // 显示车辆放电信息模态框
        function showCarDischargeInfo(car) {
            // 保存当前车辆信息
            currentCar = car;
            
            // 填充车辆基本信息
            document.getElementById('discharge-car-model').textContent = car.model;
            document.getElementById('discharge-car-plate').textContent = car.plate;
            
            // 生成并填充模拟放电数据
            generateMockDischargeData(car);
            
            // 渲染放电历史记录
            renderDischargeHistory(car.id);
            
            // 显示模态框
            const modal = document.getElementById('discharge-info-modal');
            modal.style.display = 'block';
        }
        
        // 关闭车辆放电信息模态框
        function closeDischargeInfoModal() {
            const modal = document.getElementById('discharge-info-modal');
            modal.style.display = 'none';
        }
        
        // 开始放电
        function startCarDischarge() {
            if (!currentCar) return;
            
            // 模拟开始放电过程
            const powerElement = document.getElementById('discharge-current-power');
            const durationElement = document.getElementById('discharge-duration');
            const progressBar = document.getElementById('discharge-progress-bar');
            const progressPercentage = document.getElementById('discharge-progress-percentage');
            
            let currentPower = 0;
            let duration = 0;
            let progress = 0;
            
            // 动画效果
            const interval = setInterval(() => {
                // 逐渐增加功率
                if (currentPower < 5000) {
                    currentPower += 100;
                    powerElement.textContent = currentPower;
                }
                
                // 增加时长
                duration++;
                durationElement.textContent = duration;
                
                // 更新进度
                progress = Math.min(progress + 0.5, 100);
                progressBar.style.width = progress + '%';
                progressPercentage.textContent = progress.toFixed(0) + '%';
                
                // 如果进度达到100%，停止动画
                if (progress >= 100) {
                    clearInterval(interval);
                    alert('放电完成！');
                }
            }, 1000);
        }
        
        // 生成模拟放电数据
        function generateMockDischargeData(car) {
            // 随机生成当前功率 (1000-5000W)
            const currentPower = Math.floor(Math.random() * 4000) + 1000;
            document.getElementById('discharge-current-power').textContent = currentPower;
            
            // 使用车辆的soc作为当前电量
            document.getElementById('discharge-soc').textContent = car.soc;
            
            // 计算可用能量 (电池容量 * soc / 100)
            const availableEnergy = (car.battery_capacity * car.soc / 100).toFixed(2);
            document.getElementById('discharge-available-energy').textContent = availableEnergy;
            
            // 随机生成放电时长 (0-120分钟)
            const duration = Math.floor(Math.random() * 120);
            document.getElementById('discharge-duration').textContent = duration;
            
            // 模拟放电进度
            const progress = Math.floor(Math.random() * 100);
            document.getElementById('discharge-progress-bar').style.width = progress + '%';
            document.getElementById('discharge-progress-percentage').textContent = progress + '%';
            
            // 模拟统计数据
            document.getElementById('discharge-today-total').textContent = (Math.random() * 50).toFixed(2);
            document.getElementById('discharge-month-total').textContent = (Math.random() * 200).toFixed(2);
            document.getElementById('discharge-total').textContent = (Math.random() * 1000).toFixed(2);
        }
        
        // 渲染放电历史记录
        function renderDischargeHistory(carId) {
            const historyList = document.getElementById('discharge-history-list');
            historyList.innerHTML = '';
            
            // 生成5条模拟历史记录
            for (let i = 0; i < 5; i++) {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                // 模拟日期
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                // 模拟放电数据
                const power = Math.floor(Math.random() * 4000) + 1000;
                const duration = Math.floor(Math.random() * 120) + 30;
                const energy = (Math.random() * 20).toFixed(2);
                
                historyItem.innerHTML = `
                    <div class="history-date">${dateStr}</div>
                    <div class="history-info">
                        <span>功率: ${power}W | 时长: ${duration}min</span>
                        <span>能量: ${energy}kWh</span>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            }
        }

        // 切换选项卡
        function switchTab(tabName) {
            currentTab = tabName;
            
            // 更新选项卡按钮状态
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // 更新选项卡内容显示
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // 执行充放电操作
        function executeV2GAction() {
            if (currentTab === 'discharge') {
                // 执行放电操作
                const targetSoc = parseInt(document.getElementById('target-soc').value);
                const smartMode = parseInt(document.getElementById('smart-mode').value);
                const carId = document.getElementById('discharge-car').value;

                // 验证输入
                if (targetSoc < 20 || targetSoc > 100) {
                    showNotification('目标SOC必须在20-100之间');
                    return;
                }

                // 执行放电
                discharge(targetSoc, smartMode, carId === 'auto' ? null : parseInt(carId));
            } else {
                // 执行充电操作
                const chargeAmount = parseFloat(document.getElementById('charge-amount').value);
                const carId = document.getElementById('charge-car').value;
                
                // 验证输入
                if (chargeAmount <= 0 || chargeAmount > 50) {
                    showNotification('充电电量必须在1-50kWh之间');
                    return;
                }
                
                // 执行充电
                charge(chargeAmount, carId === 'auto' ? null : parseInt(carId));
            }
            
            // 关闭模态框
            closeV2GModal();
        }

        // 智能充电函数
        async function charge(amount, car_id = null) {
            if (!authToken) {
                showNotification('请先登录');
                return;
            }
            
            try {
                const payload = {
                    amount: amount
                };
                
                if (car_id) {
                    payload.car_id = car_id;
                }
                
                const response = await fetch('http://localhost:5000/api/discharge/charge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => {});
                    throw new Error(errorData?.error || '充电请求失败');
                }
                
                const data = await response.json();
        
                
                // 更新统计数据
                totalDischarge -= data.kwh;
                totalIncome -= data.amount;
                
                // 记录交易
                const transaction = {
                    id: Date.now(),
                    type: 'charge',
                    kwh: data.kwh,
                    amount: data.amount,
                    timestamp: new Date().toLocaleString()
                };
                transactionHistory.unshift(transaction);
                
                // 更新车辆列表
                await getCars();
                
                // 更新交易记录显示
                if (isHistoryVisible) {
                    renderHistory();
                }
                
                showNotification(`充电成功，为${data.car_model}充电${data.kwh.toFixed(1)}kWh，花费¥${data.amount.toFixed(2)}`);
            } catch (error) {
                console.error('充电失败:', error);
                showNotification('充电失败: ' + error.message);
            }
        }



        // 刷新数据
        async function refreshData() {
            showLoading();
            await getCars();
            hideLoading();
            showNotification('数据已刷新');
        }

        // 切换交易记录显示
        function toggleHistory() {
            const historySection = document.getElementById('history-section');
            isHistoryVisible = !isHistoryVisible;
            
            if (isHistoryVisible) {
                historySection.style.display = 'block';
                renderHistory();
            } else {
                historySection.style.display = 'none';
            }
        }

        // 渲染交易记录
        function renderHistory() {
            const container = document.getElementById('history-container');
            
            if (transactionHistory.length === 0) {
                container.innerHTML = `
                    <div class="no-cars">
                        <span>暂无交易记录</span>
                    </div>
                `;
                return;
            }
            
            let html = '';
            transactionHistory.forEach(transaction => {
                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <div class="history-type">
                                ${transaction.type === 'discharge' ? '放电' : '充电'}记录
                            </div>
                            <div class="history-amount ${transaction.type === 'discharge' ? 'amount-discharge' : 'amount-charge'}">
                                ${transaction.type === 'discharge' ? '+' : '-'}¥${transaction.amount.toFixed(2)}
                            </div>
                        </div>
                        <div class="history-details">
                            <div>电量: ${transaction.kwh.toFixed(2)} kWh</div>
                            <div>${transaction.timestamp}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // 清空交易记录
        function clearHistory() {
            transactionHistory = [];
            renderHistory();
            showNotification('交易记录已清空');
        }

        // 显示放电结果
        function showDischargeResult(data) {
            const resultSection = document.getElementById('result-section');
            const resultTime = document.getElementById('result-time');
            const resultKwh = document.getElementById('result-kwh');
            const resultAmount = document.getElementById('result-amount');
            
            // 设置时间
            resultTime.textContent = new Date().toLocaleString();
            
            // 设置结果 - 添加空值检查
            const kwh = data?.kwh || 0;
            const amount = data?.amount || 0;
            resultKwh.textContent = kwh.toFixed(2);
            resultAmount.textContent = `¥${amount.toFixed(2)}`;
            
            // 显示结果区域
            resultSection.style.display = 'block';
            
            // 滚动到结果区域
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        // 更新实时电价 - 基于武汉分时电价政策
        function updateElectricityPrice() {
            // 武汉分时电价政策模拟（单位：元/kWh）
            // 峰时段：8:00-22:00，谷时段：22:00-次日8:00
            const now = new Date();
            const hour = now.getHours();
            
            // 基础电价设置
            let basePrice;
            if (hour >= 8 && hour < 22) {
                // 峰时段电价：1.2-1.5元/kWh
                basePrice = 1.35;
            } else {
                // 谷时段电价：0.8-1.0元/kWh
                basePrice = 0.9;
            }
            
            // 添加随机波动（±0.1元）
            const change = (Math.random() - 0.5) * 0.2;
            electricityPrice = Math.max(0.8, Math.min(2.0, basePrice + change));
            
            // 更新显示
            document.getElementById('current-price').textContent = electricityPrice.toFixed(2);
            
            // 更新电价类型显示
            const priceType = document.getElementById('price-type');
            if (hour >= 8 && hour < 22) {
                priceType.textContent = '峰时段';
                priceType.className = 'price-type peak';
            } else {
                priceType.textContent = '谷时段';
                priceType.className = 'price-type valley';
            }
        }

        // 更新用户统计数据
        function updateUserStats() {
            // 更新基本统计信息
            document.getElementById('total-discharge').textContent = `${totalDischarge.toFixed(1)} kWh`;
            document.getElementById('total-income').textContent = `¥${totalIncome.toFixed(2)}`;
            
            // 计算活跃车辆数（已连接且有足够电量的车辆）
            const activeCars = currentCars.filter(car => car.status === 'connected' && car.soc > 0).length;
            document.getElementById('active-cars').textContent = `${activeCars}辆`;
            
            // 交易次数
            const transactionCount = transactionHistory.length;
            document.getElementById('transaction-count').textContent = `${transactionCount}次`;
            
            // 更新图表数据
            updateChartData();
        }

        // 图表数据管理
        let chartData = {
            labels: [],
            discharge: [],
            charge: []
        };

        // 更新图表数据
        function updateChartData() {
            // 只保留最近10个数据点
            if (chartData.labels.length > 10) {
                chartData.labels.shift();
                chartData.discharge.shift();
                chartData.charge.shift();
            }
            
            // 添加新数据点
            const now = new Date();
            const timeLabel = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            chartData.labels.push(timeLabel);
            
            // 计算当前放电和充电量（简单模拟）
            const currentDischarge = currentCars.filter(car => car.mode === 'discharge').length * Math.random() * 5;
            const currentCharge = currentCars.filter(car => car.mode === 'charge').length * Math.random() * 3;
            
            chartData.discharge.push(currentDischarge);
            chartData.charge.push(currentCharge);
            
            // 重新绘制图表
            drawChart();
        }

        // 绘制图表
        function drawChart() {
            const canvas = document.getElementById('power-chart');
            const ctx = canvas.getContext('2d');
            
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (chartData.labels.length === 0) return;
            
            // 计算最大Y值
            const maxY = Math.max(...chartData.discharge, ...chartData.charge, 10);
            
            // 图表配置
            const padding = { top: 20, right: 20, bottom: 40, left: 40 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;
            
            // 绘制坐标轴
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            
            // X轴
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top + chartHeight);
            ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
            ctx.stroke();
            
            // Y轴
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, padding.top + chartHeight);
            ctx.stroke();
            
            // 绘制数据点和连线
            const pointWidth = chartWidth / (chartData.labels.length - 1 || 1);
            
            // 绘制放电数据（红色）
            ctx.strokeStyle = '#dc3545';
            ctx.lineWidth = 2;
            ctx.fillStyle = '#dc3545';
            
            ctx.beginPath();
            chartData.discharge.forEach((value, index) => {
                const x = padding.left + index * pointWidth;
                const y = padding.top + chartHeight - (value / maxY) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // 绘制数据点
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.stroke();
            
            // 绘制充电数据（绿色）
            ctx.strokeStyle = '#28a745';
            ctx.lineWidth = 2;
            ctx.fillStyle = '#28a745';
            
            ctx.beginPath();
            chartData.charge.forEach((value, index) => {
                const x = padding.left + index * pointWidth;
                const y = padding.top + chartHeight - (value / maxY) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // 绘制数据点
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.stroke();
            
            // 绘制图例
            ctx.font = '12px Arial';
            ctx.fillStyle = '#333';
            
            // 放电图例
            ctx.fillStyle = '#dc3545';
            ctx.fillRect(padding.left, padding.top - 15, 12, 12);
            ctx.fillStyle = '#333';
            ctx.fillText('放电功率 (kW)', padding.left + 20, padding.top - 5);
            
            // 充电图例
            ctx.fillStyle = '#28a745';
            ctx.fillRect(padding.left + 150, padding.top - 15, 12, 12);
            ctx.fillStyle = '#333';
            ctx.fillText('充电功率 (kW)', padding.left + 170, padding.top - 5);
            
            // 绘制Y轴刻度
            ctx.font = '10px Arial';
            ctx.fillStyle = '#666';
            
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (chartHeight / 5) * i;
                const value = (maxY / 5) * (5 - i);
                
                ctx.fillText(value.toFixed(1), padding.left - 25, y + 4);
                ctx.beginPath();
                ctx.moveTo(padding.left - 5, y);
                ctx.lineTo(padding.left, y);
                ctx.stroke();
            }
            
            // 绘制X轴标签
            ctx.fillStyle = '#666';
            chartData.labels.forEach((label, index) => {
                const x = padding.left + index * pointWidth;
                ctx.fillText(label, x - 15, padding.top + chartHeight + 20);
            });
        }

        // 计算电池健康度
        function calculateBatteryHealth(soc) {
            // 简单模拟，实际应该基于循环次数、温度等因素
            return Math.max(80, 100 - (80 - soc) * 0.5);
        }

        // 显示加载状态
        function showLoading() {
            const container = document.getElementById('cars-container');
            container.innerHTML = `
                <div class="skeleton-container">
                    <!-- 状态卡片骨架屏 -->
                    <div class="skeleton-card">
                        <div class="skeleton-title"></div>
                        <div class="skeleton-content"></div>
                    </div>
                    <!-- 数据卡片骨架屏 -->
                    <div class="skeleton-card">
                        <div class="skeleton-title"></div>
                        <div class="skeleton-content"></div>
                    </div>
                </div>
                <div class="loading">
                    <span>加载中...</span>
                </div>
            `;
        }

        // 隐藏加载状态
        function hideLoading() {
            // 加载完成后会自动渲染车辆列表
        }

        // 显示通知
        function showNotification(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 2秒后移除
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // 页面加载完成后执行初始化
        window.onload = () => {
            // 初始化页面
            init();
            
            // 检查本地存储的用户信息
            checkLocalUser();
        };
        
        // 为车辆添加默认模式属性
        document.addEventListener('DOMContentLoaded', () => {
            // 当车辆数据加载完成后，为每辆车添加mode属性
            if (currentCars.length > 0) {
                currentCars.forEach(car => {
                    if (!car.mode) {
                        car.mode = 'auto';
                    }
                });
            }
        });

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const dischargeModal = document.getElementById('discharge-modal');
            const chargeModal = document.getElementById('charge-modal');
            const bookingModal = document.getElementById('booking-modal');
            const executeModal = document.getElementById('execute-modal');
            
            if (event.target === dischargeModal) {
                closeDischargeModal();
            } else if (event.target === chargeModal) {
                closeChargeModal();
            } else if (event.target === bookingModal) {
                closeBookingModal();
            } else if (event.target === executeModal) {
                closeExecuteModal();
            }
        }

        // 预约页面相关功能
        function openBookingModal() {
            document.getElementById('booking-modal').style.display = 'block';
            initBookingForm();
        }

        function closeBookingModal() {
            document.getElementById('booking-modal').style.display = 'none';
        }

        function initBookingForm() {
            // 初始化时间选择器
            const now = new Date();
            const minTime = new Date(now.getTime() + 10 * 60 * 1000);
            const maxTime = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            // 设置默认预约时间为当前时间+30分钟
            const defaultTime = new Date(now.getTime() + 30 * 60 * 1000);
            document.getElementById('reserve-time').value = formatDateTimeForInput(defaultTime);
            document.getElementById('reserve-time').min = formatDateTimeForInput(minTime);
            document.getElementById('reserve-time').max = formatDateTimeForInput(maxTime);

            // 默认电量70%
            document.getElementById('battery-level').value = 70;
            document.getElementById('battery-value').textContent = '70%';

            // 默认车型
            document.getElementById('car-model').value = '比亚迪 汉 EV';

            // 默认放电时长
            document.querySelector('input[name="duration"][value="15"]').checked = true;

            // 检查是否可以提交
            checkBookingSubmit();
        }

        function formatDateTimeForInput(date) {
            return date.toISOString().slice(0, 16); // 格式：YYYY-MM-DDTHH:MM
        }

        // 电量变化处理
        document.addEventListener('DOMContentLoaded', function() {
            const batterySlider = document.getElementById('battery-level');
            if (batterySlider) {
                batterySlider.addEventListener('input', function(e) {
                    const value = e.target.value;
                    document.getElementById('battery-value').textContent = value + '%';
                    checkBookingSubmit();
                });
            }

            // 提交预约
            const submitBtn = document.getElementById('submit-booking');
            if (submitBtn) {
                submitBtn.addEventListener('click', function() {
                    // 收集表单数据
                    const formData = {
                        carModel: document.getElementById('car-model').value,
                        batteryLevel: parseInt(document.getElementById('battery-level').value),
                        reserveTime: document.getElementById('reserve-time').value,
                        duration: parseInt(document.querySelector('input[name="duration"]:checked').value),
                        dischargeCapacity: document.querySelector('input[name="duration"]:checked').value === '15' ? 3.5 : 7
                    };

                    // 显示加载状态
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = '提交中...';
                    submitBtn.disabled = true;

                    // 模拟API请求
                    setTimeout(() => {
                        // 恢复按钮状态
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        
                        // 显示成功消息
                        showNotification('预约成功！');
                        
                        // 关闭模态框
                        closeBookingModal();
                        
                        // 创建任务信息对象
                        const taskInfo = {
                            taskId: `TASK${Date.now()}`,
                            carModel: formData.carModel,
                            scheduledTime: formData.reserveTime,
                            durationMinutes: formData.duration,
                            dischargedKwh: formData.dischargeCapacity
                        };
                        
                        // 打开任务执行模态框
                        openExecuteModal(taskInfo);
                    }, 1500);
                });
            }
        });

        // 检查是否可以提交预约
        function checkBookingSubmit() {
            const batteryLevel = parseInt(document.getElementById('battery-level').value);
            const submitBtn = document.getElementById('submit-booking');
            
            if (submitBtn) {
                if (batteryLevel >= 50) {
                    submitBtn.disabled = false;
                    submitBtn.style.backgroundColor = '#1677ff';
                } else {
                    submitBtn.disabled = true;
                    submitBtn.style.backgroundColor = '#cccccc';
                }
            }
        }

        // 任务执行相关功能
        let countdownTimer = null;
        let subscribed = false;
        let reminderTimer = null;
        let hasShownReminder = false;

        // 打开任务执行模态框
        function openExecuteModal(taskInfo) {
            // 设置任务信息
            document.getElementById('task-id').textContent = taskInfo.taskId || `TASK${Date.now()}`;
            document.getElementById('task-car-model').textContent = taskInfo.carModel || '比亚迪 汉 EV';
            document.getElementById('task-scheduled-time').textContent = taskInfo.scheduledTime || new Date().toLocaleString();
            document.getElementById('task-duration').textContent = taskInfo.durationMinutes || 15;
            document.getElementById('task-discharged-kwh').textContent = taskInfo.dischargedKwh || 3.5;
            
            // 显示模态框
            document.getElementById('execute-modal').style.display = 'block';
            
            // 检查并启动倒计时
            checkCountdown(taskInfo);
            
            // 检查订阅状态
            checkSubscriptionStatus();
            
            // 启动提醒定时器
            startReminderTimer();
        }

        // 关闭任务执行模态框
        function closeExecuteModal() {
            document.getElementById('execute-modal').style.display = 'none';
            
            // 清除倒计时和提醒定时器
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            clearReminderTimer();
        }

        // 检查倒计时
        function checkCountdown(taskInfo) {
            const scheduledTime = new Date(taskInfo.scheduledTime);
            const now = new Date();
            const timeDiff = scheduledTime - now;
            
            if (timeDiff > 0) {
                // 显示倒计时
                document.getElementById('countdown-tip').style.display = 'flex';
                updateCountdown(timeDiff);
                
                // 每秒更新倒计时
                countdownTimer = setInterval(() => {
                    const remainingTime = scheduledTime - new Date();
                    if (remainingTime > 0) {
                        updateCountdown(remainingTime);
                    } else {
                        clearInterval(countdownTimer);
                        document.getElementById('countdown-tip').style.display = 'none';
                        document.getElementById('task-status').textContent = '可执行';
                    }
                }, 1000);
            } else {
                // 任务已到执行时间
                document.getElementById('countdown-tip').style.display = 'none';
                document.getElementById('task-status').textContent = '可执行';
            }
        }

        // 更新倒计时显示
        function updateCountdown(milliseconds) {
            const minutes = Math.floor(milliseconds / 60000);
            const seconds = Math.floor((milliseconds % 60000) / 1000);
            document.getElementById('countdown-text').textContent = `${minutes}分${seconds}秒`;
        }

        // 检查订阅状态
        function checkSubscriptionStatus() {
            const storedSubscribed = localStorage.getItem('subscribed');
            subscribed = storedSubscribed === 'true';
        }

        // 开始放电任务
        function startDischargeTask() {
            const startBtn = document.getElementById('start-discharge-btn');
            
            // 确认用户是否准备就绪
            if (confirm('确定要开始放电吗？\n\n请确保：\n1. 车辆已停稳并处于安全状态\n2. 车辆电量充足（≥50%）')) {
                const originalText = startBtn.innerHTML;
                
                // 显示加载状态
                startBtn.innerHTML = '<span class="btn-icon">⏳</span><span class="btn-text">处理中...</span>';
                startBtn.disabled = true;
                
                // 模拟API请求
                setTimeout(() => {
                    // 恢复按钮状态
                    startBtn.innerHTML = originalText;
                    startBtn.disabled = false;
                    
                    // 显示成功消息
                    showNotification('放电已启动');
                    
                    // 更新任务状态
                    document.getElementById('task-status').textContent = '进行中';
                    
                    // 调用开始放电API（模拟）
                    callStartDischargeAPI();
                    
                    // 关闭模态框
                    setTimeout(() => {
                        closeExecuteModal();
                    }, 2000);
                }, 1500);
            }
        }

        // 模拟调用开始放电API
        function callStartDischargeAPI() {
            // 实际项目中应该调用真实的API
            console.log('调用开始放电API');
            
            // 更新状态
            document.getElementById('power-status').textContent = '放电中';
            document.getElementById('power-status').style.color = '#1a73e8';
            document.getElementById('current-power').textContent = Math.floor(Math.random() * 3000 + 1000); // 1000-4000W
        }

        // 订阅消息
        function subscribeMessage() {
            // 模拟微信订阅消息API调用
            setTimeout(() => {
                // 假设用户同意订阅
                subscribed = true;
                
                // 保存订阅状态到本地缓存
                localStorage.setItem('subscribed', 'true');
                
                // 显示成功消息
                showNotification('订阅成功！将在任务开始前5分钟提醒您');
                
                // 更新任务状态
                document.getElementById('task-status').textContent = '已订阅提醒';
            }, 1000);
        }

        // 启动提醒定时器
        function startReminderTimer() {
            // 每30秒检查一次任务时间
            reminderTimer = setInterval(() => {
                checkTaskReminder();
            }, 30000);
        }

        // 清除提醒定时器
        function clearReminderTimer() {
            if (reminderTimer) {
                clearInterval(reminderTimer);
                reminderTimer = null;
            }
            hasShownReminder = false;
        }

        // 检查任务提醒
        function checkTaskReminder() {
            const scheduledTime = new Date(document.getElementById('task-scheduled-time').textContent);
            const now = new Date();
            const timeDiff = scheduledTime - now;
            
            // 如果距离任务开始还有5分钟（300000毫秒）且尚未显示提醒
            if (timeDiff > 0 && timeDiff <= 300000 && !hasShownReminder) {
                showReminder();
                hasShownReminder = true;
            }
        }

        // 显示提醒
        function showReminder() {
            if (subscribed) {
                // 模拟模板消息推送
                mockPushTemplateMessage();
            } else {
                // 显示订阅提示
                if (confirm('任务即将开始，是否订阅提醒消息？')) {
                    subscribeMessage();
                }
            }
        }

        // 模拟模板消息推送
        function mockPushTemplateMessage() {
            showNotification('📢 任务提醒：您的V2G放电任务将在5分钟后开始，请准备就绪！');
        }
    </script>
</body>
</html>